{
  "hash": "f1cb795c0f2a72c1e51e618e38c2b2da",
  "result": {
    "markdown": "::: {.content-hidden unless-format=\"html\"}\n$$\n\\newcommand{\\tr}{\\mathrm{tr}}\n\\newcommand{\\rank}{\\mathrm{rank}}\n\\newcommand{\\plim}{\\operatornamewithlimits{plim}}\n\\newcommand{\\diag}{\\mathrm{diag}}\n\\newcommand{\\bm}[1]{\\boldsymbol{\\mathbf{#1}}}\n\\newcommand{\\Var}{\\mathrm{Var}}\n\\newcommand{\\Exp}{\\mathrm{E}}\n\\newcommand{\\Cov}{\\mathrm{Cov}}\n\\newcommand\\given[1][]{\\:#1\\vert\\:}\n\\newcommand{\\irow}[1]{%\n\\begin{pmatrix}#1\\end{pmatrix}\n}\n$$\n:::\n\n# Spatial Regression Models\n\n### Required packages {.unnumbered}\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-1_cc16623520b247aa99191d3c32898fb1'}\n\n```{.r .cell-code}\npkgs <- c(\"sf\", \"mapview\", \"spdep\", \"spatialreg\", \"tmap\", \"viridisLite\") # note: load spdep first, then spatialreg\nlapply(pkgs, require, character.only = TRUE)\n```\n:::\n\n\n\n### Session info {.unnumbered}\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-2_302f93b252790934ab1644fd0dc7eda7'}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.4.1 (2024-06-14 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 22631)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United Kingdom.utf8 \n[2] LC_CTYPE=English_United Kingdom.utf8   \n[3] LC_MONETARY=English_United Kingdom.utf8\n[4] LC_NUMERIC=C                           \n[5] LC_TIME=English_United Kingdom.utf8    \n\ntime zone: Europe/Berlin\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] viridisLite_0.4.2 tmap_3.3-4        spatialreg_1.3-4  Matrix_1.7-0     \n[5] spdep_1.3-5       spData_2.3.1      mapview_2.11.2    sf_1.0-16        \n\nloaded via a namespace (and not attached):\n [1] xfun_0.45          raster_3.6-26      htmlwidgets_1.6.4  lattice_0.22-6    \n [5] tools_4.4.1        crosstalk_1.2.1    LearnBayes_2.15.1  parallel_4.4.1    \n [9] stats4_4.4.1       sandwich_3.1-0     proxy_0.4-27       KernSmooth_2.23-24\n[13] satellite_1.0.5    RColorBrewer_1.1-3 leaflet_2.2.2      lifecycle_1.0.4   \n[17] compiler_4.4.1     deldir_2.0-4       munsell_0.5.1      terra_1.7-78      \n[21] codetools_0.2-20   leafsync_0.1.0     stars_0.6-5        htmltools_0.5.8.1 \n[25] class_7.3-22       MASS_7.3-60.2      classInt_0.4-10    lwgeom_0.2-14     \n[29] wk_0.9.1           abind_1.4-5        boot_1.3-30        multcomp_1.4-25   \n[33] nlme_3.1-164       digest_0.6.35      mvtnorm_1.2-5      splines_4.4.1     \n[37] fastmap_1.2.0      grid_4.4.1         colorspace_2.1-0   cli_3.6.2         \n[41] magrittr_2.0.3     base64enc_0.1-3    dichromat_2.0-0.1  XML_3.99-0.16.1   \n[45] survival_3.6-4     leafem_0.2.3       TH.data_1.1-2      e1071_1.7-14      \n[49] scales_1.3.0       sp_2.1-4           rmarkdown_2.27     zoo_1.8-12        \n[53] png_0.1-8          coda_0.19-4.1      evaluate_0.24.0    knitr_1.47        \n[57] tmaptools_3.1-1    s2_1.1.6           rlang_1.1.4        Rcpp_1.0.12       \n[61] glue_1.7.0         DBI_1.2.3          rstudioapi_0.16.0  jsonlite_1.8.8    \n[65] R6_2.5.1           units_0.8-5       \n```\n:::\n:::\n\n\n\n### Reload data from pervious session {.unnumbered}\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-3_a62c1754e5ba8a3b8d7a6bd0ff4078a4'}\n\n```{.r .cell-code}\nload(\"_data/msoa2_spatial.RData\")\n```\n:::\n\n\n\n\n\nThere are various techniques to model spatial dependence and spatial processes [@LeSage.2009]. Here, we will just cover a few of the most common techniques / econometric models. One advantage of the most basic spatial model (SLX) is that this method can easily be incorporated in a variety of other methodologies, such as machine learning approaches.\n\nFor more in-depth materials see @LeSage.2009 and @Kelejian.2017. @Franzese.2007, @HalleckVega.2015, @LeSage.2014, @Ruttenauer.2022a, and @Wimpy.2021 provide article-length introductions. @Ruttenauer.2024b is a handbook chapter based on the materials of this workshop.\n\n\n## Why do we need spatial regression models\n\n### Non-spatial OLS\n\nLet us start with a linear model, where $\\bm y$ is the outcome or dependent variable ($N \\times 1$), $\\bm X$ are various exogenous covariates ($N \\times k$), and $\\bm \\varepsilon$ ($N \\times 1$) is the error term. We are usually interested in the coefficient vector $\\bm \\beta$ ($k \\times 1$) and its insecurity estimates.\n\n$$\n{\\bm y}={\\bm X}{\\bm \\beta}+ {\\bm \\varepsilon}\n$$\nThe work-horse for estimating $\\bm \\beta$ in the social science is the OLS estimator [@Wooldridge.2010].\n\n$$\n\\hat{\\beta}=({\\bm X}^\\intercal{\\bm X})^{-1}{\\bm X}^\\intercal{\\bm y}.\n$$\n\n\n\n::: {.callout-important}\n### OLS assumptions I\n\n1. $\\Exp(\\epsilon_i|\\bm X_i) = 0$: for every value of $X$, the average / expectation of the error term $\\bm \\varepsilon$ equals zero -- put differently: the error term is independent of $X$,\n\n2. the observations of the sample are independent and identically distributed (i.i.d),\n \n3. the fourth moments of the variables $\\bm X_i$ and $Y_i$ are positive and definite -- put differently: extreme values / outliers are very very rare,\n\n4. $\\text{rank}(\\bm X) = K$: the matrix $\\bm X$ has full rank -- put differently: no perfect multicollinearity between the covariates,\n:::\n\n::: {.callout-important}\n### OLS assumptions II\n\n5. $\\Var(\\varepsilon|x) = \\sigma^2$: the error terms $\\varepsilon$ are homoskedastic / have the same variance given any value of the explanatory variable, \n\n6. $\\varepsilon \\sim \\mathcal{N}(0, \\sigma^2)$: the error terms $\\varepsilon$ are normally distributed (conditional on the explanatory variables $X_i$).\n\n:::\n\n::: {.callout-tip}\n### Question\n\nWhich of the six assumptions above may be violated by spatial dependence?\n\n:::\n\n![](fig/assumptions.jpg)\n\n### Problem of ignoring spatial dependence\n\nDoes spatial dependence influence the results / coefficient estimates of non-spatial regression models, or in other words: is ignoring spatial dependence harmful?\n\nI've heard different answers, ranging from \"It only affects the standard errors\" to \"it always introduces bias\". As so often, the true (or best?) answer is somewhere in the middle: *it depends* [@Betz.2020; @Cook.2020; @Pace.2010; @Ruttenauer.2022a].\n\nThe easiest way to think of it is analogous to the omit variable bias [@Betz.2020; @Cook.2020]:\n\n$$\nplim~\\hat{\\beta}_{OLS}= \\beta  + \\gamma \\frac{\\Cov(\\bm x, \\bm z)}{\\Var(\\bm x)},\n$$\n\nwhere $z$ is some omit variable, and $\\gamma$ is the conditional effect of $\\bm z$ on $\\bm y$. Now imagine that the neighbouring values of the dependent variable $\\bm W \\bm y$ are autocorrelated to focal unit which we denote with $\\rho > 0$, and that the covariance between the focal unit's exogenous covariates and $\\bm W \\bm y$ is not zero. Then we will have an omitted variable bias due to spatial dependence:\n\n$$\nplim~\\hat{\\beta}_{OLS}= \\beta  + \\rho \\frac{\\Cov(\\bm x, \\bm W \\bm y)}{\\Var(\\bm x)} \\neq \\beta,\n$$\n\nFor completeness, the entire bias is a bit more complicated [@Pace.2010; @Ruttenauer.2022a] and looks like:\n\n$$\nplim~\\hat{\\beta}=\\frac{\\sum_{ij}({\\bm M}(\\delta){\\bm M}(\\delta)^\\intercal\\circ{\\bm M}(\\rho))_{ij}}\n{\\tr({\\bm M}(\\delta){\\bm M}(\\delta)^\\intercal)}\\beta \\\\\n+\\frac{\\sum_{ij}({\\bm M}(\\delta){\\bm M}(\\delta)^\\intercal\\circ{\\bm M}(\\rho){\\bm W})_{ij}}\n{\\tr({\\bm M}(\\delta){\\bm M}(\\delta)^\\intercal)}\\theta,\n$$\nwhere $\\circ$ denotes the Hadamard product, ${\\bm M}(\\delta)=({\\bm I}_N-\\delta{\\bm W})^{-1}$, and ${\\bm M}(\\rho)=({\\bm I}_N-\\rho{\\bm W})^{-1}$.\n\n<p><center>*(Don't worry, no need to learn by hard!!)*</center></p>\n\n\nEssentially, the non-spatial OLS estimator $\\beta_{OLS}$ is biased in the presence of either [@Pace.2010; @Ruttenauer.2022a]:\n\n- Spatial autocorrelation in the dependent variable ($\\rho\\neq0$) and spatial autocorrelation in the covariate ($\\delta\\neq0$). This bias increases with $\\rho$, $\\delta$, and $\\beta$.\n\n- Local spatial spillover effects ($\\theta\\neq0$) and spatial autocorrelation in the covariate ($\\delta\\neq0$). This is analogous to the omitted variable bias resulting from the omission of ${\\bm W} {\\bm x}$. It increases with $\\theta$ and $\\delta$, but additionally with $\\rho$ if $\\theta\\neq0$ and $\\delta\\neq0$.\n\n- An omitted variable and $\\mathrm{E}({\\bm \\varepsilon}|{\\bm x})\\neq0$. This non-spatial omitted variable bias $\\gamma$ is amplified by spatial dependence in the disturbances ($\\lambda$) and spatial autocorrelation in the dependent variable ($\\rho$), but also increases with positive values of $\\delta$ if either $\\rho\\neq 0$ or $\\lambda\\neq 0$. Obviously, it also increases with $\\gamma$.\n\n\n\n## Spatial Regression Models\n\nBroadly, spatial dependence or clustering in some characteristic can be the result of three different processes:\n\n![](fig/Graph.jpg)\n\nStrictly speaking, there are some other possibilities too, such as measurement error or the wrong choice on the spatial level. For instance, imagine we have a city-specific characteristic (e.g. public spending) allocated to neighbourhood units. Obviously, this will introduce heavy autocorrelation on the neighbourhood level by construction.\n\nThere are three basic ways of incorporating spatial dependence, which then can be further combined. As before, the $N \\times N$ spatial weights matrix $\\bm W$ defines the spatial relationship between units.\n\n\n### Spatial Error Model (SEM)\n\n* Clustering on Unobservables\n\n$$\n\t\t\\begin{split}\n\t\t{\\bm y}&=\\alpha{\\bm \\iota}+{\\bm X}{\\bm \\beta}+{\\bm u},\\\\\n\t\t{\\bm u}&=\\lambda{\\bm W}{\\bm u}+{\\bm \\varepsilon}\n\t\t\\end{split} \n$$\t\t\n\n$\\lambda$ denotes the strength of the spatial correlation in the errors of the model: *your errors influence my errors*. \n\n- $> 0$: positive error dependence,\n- $< 0$: negative error dependence,\n- $= 0$: traditional OLS model.\n\n$\\lambda$ is defined in the range $[-1, +1]$.\n\n### Spatial Autoregressive Model (SAR)\n\n* Interdependence\n\n$$\n\t\t{\\bm y}=\\alpha{\\bm \\iota}+\\rho{\\bm W}{\\bm y}+{\\bm X}{\\bm \\beta}+ {\\bm \\varepsilon}\n$$\t\n\n$\\rho$ denotes the strength of the spatial correlation in the dependent variable (spatial autocorrelation): *your outcome influences my outcome*. \n\n- $> 0$: positive spatial dependence,\n- $< 0$: negative spatial dependence,\n- $= 0$: traditional OLS model.\n\n$\\rho$ is defined in the range $[-1, +1]$.\n\n### Spatially lagged X Model (SLX)\n\n* Spillovers in Covariates\n\n$$\n\t\t{\\bm y}=\\alpha{\\bm \\iota}+{\\bm X}{\\bm \\beta}+{\\bm W}{\\bm X}{\\bm \\theta}+ {\\bm \\varepsilon}\n$$\t\n\n$\\theta$ denotes the strength of the spatial spillover effects from covariate(s) on the dependent variable: *your covariates influence my outcome*. \n\n$\\theta$ is basically like any other coefficient from a covariate. It is thus not bound to any range.\n\nMoreover, there are models combining two sets of the above specifications.\n\n### Spatial Durbin Model (SDM)\n\n* Interdependence\n* Spillovers in Covariates\n\n$$\n\t\t{\\bm y}=\\alpha{\\bm \\iota}+\\rho{\\bm W}{\\bm y}+{\\bm X}{\\bm \\beta}+{\\bm W}{\\bm X}{\\bm \\theta}+ {\\bm \\varepsilon}\n$$\t\n\n### Spatial Durbin Error Model (SDEM)\n\n* Clustering on Unobservables\n* Spillovers in Covariates\n\n$$\n\t\t\\begin{split}\n\t\t{\\bm y}&=\\alpha{\\bm \\iota}+{\\bm X}{\\bm \\beta}+{\\bm W}{\\bm X}{\\bm \\theta}+ {\\bm u},\\\\\n\t\t{\\bm u}&=\\lambda{\\bm W}{\\bm u}+{\\bm \\varepsilon}\n\t\t\\end{split}\n$$\n\n### Combined Spatial Autocorrelation Model (SAC)\n\n* Clustering on Unobservables\n* Interdependence\n\n$$\n\t\t\\begin{split}\n\t\t{\\bm y}&=\\alpha{\\bm \\iota}+\\rho{\\bm W}{\\bm y}+{\\bm X}{\\bm \\beta}+ {\\bm u},\\\\\n\t\t{\\bm u}&=\\lambda{\\bm W}{\\bm u}+{\\bm \\varepsilon}\n\t\t\\end{split}\n$$\n\n\n### General Nesting Spatial Model (GNS)\n\n* Clustering on Unobservables\n* Interdependence\n* Spillovers in Covariates\n\n$$\n\t\t\\begin{split}\n\t\t{\\bm y}&=\\alpha{\\bm \\iota}+\\rho{\\bm W}{\\bm y}+{\\bm X}{\\bm \\beta}+{\\bm W}{\\bm X}{\\bm \\theta}+ {\\bm u},\\\\\n\t\t{\\bm u}&=\\lambda{\\bm W}{\\bm u}+{\\bm \\varepsilon}\n\t\t\\end{split}\n$$\n\n\n::: callout-tip\n## Manski's reflection problem\n\nThe General Nesting Spatial Model (GNS) is only weakly (or not?) identifiable [@Gibbons.2012]. \n\nIt's analogous to Manski's reflection problem on neighbourhood effects @Manski.1993: If people in the same group behave similar, this can be because a) imitating behaviour of the group, b) exogenous characteristics of the group influence the behaviour, and c) members of the same group are exposed to the same external circumstances. *We just cannot separate those in observational data.*\n:::\n\nNote that all of these models assume different data generating processes (DGP) leading to the spatial pattern. Although there are specifications tests, it is generally not possible to let the data decide which one is the true underlying DGP [@Cook.2020; @Ruttenauer.2022a]. However, there might be theoretical reasons to guide the model specification [@Cook.2020]. \n\nJust because SAR is probably the most commonly used model does not make it the best choice. In contrast, various studies [@HalleckVega.2015; @Ruttenauer.2022a; @Wimpy.2021] highlight the advantages of the relative simple SLX model. Moreover, this specification can basically be incorporated in any other statistical method.\n\n### A note on missings\n\nMissing values create a problem in spatial data analysis. For instance, in a local spillover model with an average of 10 neighbours, two initial missing values will lead to 20 missing values in the spatially lagged variable. For global spillover models, one initial missing will 'flow' through the neighbourhood system until the cutoff point (and create an excess amount of missings). \n\nDepending on the data, units with missings can either be dropped and omitted from the initial weights creation, or we need to impute the data first, e.g. using interpolation or Kriging.\n\n## Mini Example\n\nLet's try to make sense of this. We rely on a mini example using a few units in Camden\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-4_1ff64692112823e85820530643683134'}\n\n```{.r .cell-code}\nsub.spdf <- msoa.spdf[c(172, 175, 178, 179, 181, 182), ]\nmapview(sub.spdf)\n```\n\n::: {.cell-output-display}\n![](05_regression-theory_files/figure-pdf/unnamed-chunk-4-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nWe then construct queens neighbours, and have a look at the resulting non-normalized matrix $\\bm W$.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-5_2237b5033d5246dabaf07e17564eb4f6'}\n\n```{.r .cell-code}\nqueens.nb <- poly2nb(sub.spdf, queen = TRUE, snap = 1)\nW <- nb2mat(queens.nb, style = \"B\")\nW\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    [,1] [,2] [,3] [,4] [,5] [,6]\n172    0    0    1    0    0    0\n175    0    0    0    1    0    1\n178    1    0    0    1    1    0\n179    0    1    1    0    1    1\n181    0    0    1    1    0    1\n182    0    1    0    1    1    0\nattr(,\"call\")\nnb2mat(neighbours = queens.nb, style = \"B\")\n```\n:::\n:::\n\n\nWe have selected 6 units. So, $\\bm W$ is a $6 \\times 6$ matrix. we see that observation 1 has one neighbour: observation 3. Observation 2 has two nieghbours: observation 4 and observation 6. The diagonal is zero: no unit is a neighbour of themselves.\n\nNo we row-normalize this matrix.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-6_3bbef99b175d7e1c286fa7a0f8a09eff'}\n\n```{.r .cell-code}\nqueens.lw <- nb2listw(queens.nb,\n                      style = \"W\")\nW_rn <- listw2mat(queens.lw)\nW_rn\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         [,1]      [,2]      [,3]      [,4]      [,5]      [,6]\n172 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000 0.0000000\n175 0.0000000 0.0000000 0.0000000 0.5000000 0.0000000 0.5000000\n178 0.3333333 0.0000000 0.0000000 0.3333333 0.3333333 0.0000000\n179 0.0000000 0.2500000 0.2500000 0.0000000 0.2500000 0.2500000\n181 0.0000000 0.0000000 0.3333333 0.3333333 0.0000000 0.3333333\n182 0.0000000 0.3333333 0.0000000 0.3333333 0.3333333 0.0000000\n```\n:::\n:::\n\n\n\nNo every single weight $w_{ij}$ is divided by the total number of neighbours $n_i$ of the focal unit. For observation 1, observation 3 is the only neighbour, thus a weight = 1. FOr observation two, both neighbours have a weight of 1/2. For obervation 3 (with three neighbours) each neighbour got a weight of 1/3.\n\n\n::: callout-tip\n## Question\n\nWhat happens if we multiply this matrix $\\bm W$ with a $N \\times 1$ vector $\\bm y$ or $\\bm x$?\n:::\n\nA short reminder on matrix multiplication. \n\n$$\n\\bm W * \\bm y =\n\\begin{bmatrix}\nw_{11} & w_{12} & w_{13}\\\\\nw_{21} & w_{22} & w_{23}\\\\\nw_{31} & w_{32} & w_{33} \n\\end{bmatrix} *\n\\begin{bmatrix}\ny_{11} \\\\\ny_{21} \\\\\ny_{31}  \n\\end{bmatrix}\\\\\n= \\begin{bmatrix}\nw_{11}y_{11} + w_{12}y_{21} + w_{13}y_{31}\\\\\nw_{21}y_{11} + w_{22}y_{21} + w_{23}y_{31}\\\\\nw_{31}y_{11} + w_{32}y_{21} + w_{33}y_{31}  \n\\end{bmatrix}\n$$\n\nEach line of $\\bm W * \\bm y$ just gives a weighted average of the other $y$-values $y_j$ in the sample. In case of the row-normalization, each neighbour gets the same weight $\\frac{1}{n_i}$. This is simply the mean of $y_j$ of the neighbours in case of a row-normalized contiguity weights matrix.\n\nNote that the *mean* interpretation is only valid with row-normalization. What would we get with inverse-distance based weights?\n\nLet's look at this in our example\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-7_a28f5ff9ce255be652bd4e65aeb1ec55'}\n\n```{.r .cell-code}\ny <- sub.spdf$med_house_price\nx <- sub.spdf$pubs_count\n\nW_rn\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         [,1]      [,2]      [,3]      [,4]      [,5]      [,6]\n172 0.0000000 0.0000000 1.0000000 0.0000000 0.0000000 0.0000000\n175 0.0000000 0.0000000 0.0000000 0.5000000 0.0000000 0.5000000\n178 0.3333333 0.0000000 0.0000000 0.3333333 0.3333333 0.0000000\n179 0.0000000 0.2500000 0.2500000 0.0000000 0.2500000 0.2500000\n181 0.0000000 0.0000000 0.3333333 0.3333333 0.0000000 0.3333333\n182 0.0000000 0.3333333 0.0000000 0.3333333 0.3333333 0.0000000\n```\n:::\n\n```{.r .cell-code}\ny\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 376812.5 414625.0 713125.0 322750.0 495000.0 364000.0\n```\n:::\n\n```{.r .cell-code}\nx\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1 3 3 1 9 7\n```\n:::\n\n```{.r .cell-code}\nW_rn_y <- W_rn %*% y\nW_rn_x <- W_rn %*% x\nW_rn_y\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        [,1]\n172 713125.0\n175 343375.0\n178 398187.5\n179 496687.5\n181 466625.0\n182 410791.7\n```\n:::\n\n```{.r .cell-code}\nW_rn_x\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        [,1]\n172 3.000000\n175 4.000000\n178 3.666667\n179 5.500000\n181 3.666667\n182 4.333333\n```\n:::\n:::\n\n\n\nLet's check if our interpretation is true\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-8_c85998e5f12372a34f72eea3ee9eb540'}\n\n```{.r .cell-code}\nW_rn_y[1] == y[3]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n\n```{.r .cell-code}\nW_rn_y[2] == mean(y[c(4, 6)])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n\n```{.r .cell-code}\nW_rn_y[4] == mean(y[c(2, 3, 5, 6)])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n\n\n\n\n\n## Real Example\n\nFirst, we need the a spatial weights matrix.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-9_7f36c32fc0c7fce8c9536102d4f88f3c'}\n\n```{.r .cell-code}\n# Contiguity (Queens) neighbours weights\nqueens.nb <- poly2nb(msoa.spdf, \n                     queen = TRUE, \n                     snap = 1) # we consider points in 1m distance as 'touching'\nqueens.lw <- nb2listw(queens.nb,\n                      style = \"W\")\n```\n:::\n\n\n\nWe can estimate spatial models using `spatialreg`. \n\n### SAR\n\nLet's estimate a spatial SAR model using the `lagsarlm()` with contiguity weights. We use median house value as depended variable, and include population density (`POPDEN`), the air pollution (`no2`), and the share of ethnic minorities (`per_mixed`, `per_asian`, `per_black`,  `per_other`).\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-10_d6612b35eb1bbc27e961f02fd56f162f'}\n\n```{.r .cell-code}\nmod_1.sar <- lagsarlm(log(med_house_price) ~ log(no2) + log(POPDEN) + \n                        per_mixed + per_asian + per_black + per_other,  \n                      data = msoa.spdf, \n                      listw = queens.lw,\n                      Durbin = FALSE) # we could here extend to SDM\nsummary(mod_1.sar)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:lagsarlm(formula = log(med_house_price) ~ log(no2) + log(POPDEN) + \n    per_mixed + per_asian + per_black + per_other, data = msoa.spdf, \n    listw = queens.lw, Durbin = FALSE)\n\nResiduals:\n       Min         1Q     Median         3Q        Max \n-0.5281789 -0.1220524 -0.0099245  0.0992203  1.0936745 \n\nType: lag \nCoefficients: (asymptotic standard errors) \n               Estimate  Std. Error  z value  Pr(>|z|)\n(Intercept)  3.17383180  0.29041604  10.9286 < 2.2e-16\nlog(no2)     0.39705423  0.04452880   8.9168 < 2.2e-16\nlog(POPDEN) -0.05583014  0.01242876  -4.4920 7.055e-06\nper_mixed    0.01851577  0.00579832   3.1933  0.001407\nper_asian   -0.00228346  0.00045876  -4.9775 6.442e-07\nper_black   -0.01263650  0.00100282 -12.6009 < 2.2e-16\nper_other   -0.00161419  0.00289082  -0.5584  0.576582\n\nRho: 0.66976, LR test value: 473.23, p-value: < 2.22e-16\nAsymptotic standard error: 0.025311\n    z-value: 26.461, p-value: < 2.22e-16\nWald statistic: 700.19, p-value: < 2.22e-16\n\nLog likelihood: 196.7203 for lag model\nML residual variance (sigma squared): 0.035402, (sigma: 0.18815)\nNumber of observations: 983 \nNumber of parameters estimated: 9 \nAIC: -375.44, (AIC for lm: 95.786)\nLM test for residual autocorrelation\ntest value: 8.609, p-value: 0.0033451\n```\n:::\n:::\n\n\n\nThis looks pretty much like a conventional model output, with some additional information: a highly significant `mod_1.sar$rho` of 0.67 indicates strong positive spatial autocorrelation. \n\nRemember that is the coefficient for the term $\\bm y = \\rho \\bm W \\bm y \\ldots$. It is bound to be below 1 for positive autocorrelation.\n\nIn substantive terms, house prices in the focal unit positively influence house prices in neighbouring units, which again influences house prices among the neighbours of these neighbours, and so on (we'll get back to this).\n\n::: callout-warning\nThe coefficients of covariates in a SAR model are not marginal or partical effects, because of the spillovers and feedback loops in $\\bm y$ (see below)!\n\nFrom the coefficient, we can only interpret the direction: there's a positive effect of air pollution and a negative effect of population sensity, and so on...\n:::\n\n\n\n### SEM\n\nSEM models can be estimated using `errorsarlm()`.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-11_289510c01a18e19f64bbecafbc1ff035'}\n\n```{.r .cell-code}\nmod_1.sem <- errorsarlm(log(med_house_price) ~ log(no2) + log(POPDEN) +\n                          per_mixed + per_asian + per_black + per_other,  \n                        data = msoa.spdf, \n                        listw = queens.lw,\n                        Durbin = FALSE) # we could here extend to SDEM\nsummary(mod_1.sem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:errorsarlm(formula = log(med_house_price) ~ log(no2) + log(POPDEN) + \n    per_mixed + per_asian + per_black + per_other, data = msoa.spdf, \n    listw = queens.lw, Durbin = FALSE)\n\nResiduals:\n      Min        1Q    Median        3Q       Max \n-0.581785 -0.105218 -0.012758  0.094430  0.913425 \n\nType: error \nCoefficients: (asymptotic standard errors) \n               Estimate  Std. Error  z value  Pr(>|z|)\n(Intercept) 12.92801104  0.35239139  36.6865 < 2.2e-16\nlog(no2)     0.15735296  0.10880727   1.4462 0.1481317\nlog(POPDEN) -0.08316270  0.01254315  -6.6301 3.354e-11\nper_mixed   -0.03377962  0.00811054  -4.1649 3.115e-05\nper_asian   -0.00413115  0.00096849  -4.2656 1.994e-05\nper_black   -0.01653816  0.00126741 -13.0488 < 2.2e-16\nper_other   -0.01693012  0.00462999  -3.6566 0.0002556\n\nLambda: 0.88605, LR test value: 623.55, p-value: < 2.22e-16\nAsymptotic standard error: 0.015803\n    z-value: 56.068, p-value: < 2.22e-16\nWald statistic: 3143.6, p-value: < 2.22e-16\n\nLog likelihood: 271.8839 for error model\nML residual variance (sigma squared): 0.026911, (sigma: 0.16405)\nNumber of observations: 983 \nNumber of parameters estimated: 9 \nAIC: -525.77, (AIC for lm: 95.786)\n```\n:::\n:::\n\n\n\nIn this case `mod_1.sem$lambda` gives us the spatial parameter. A highly significant lambda of 0.89 indicates that the errors are highly spatially correlated (e.g. due to correlated unobservables). Again, $\\lambda = 1 $ would be the maximum.\n\nIn spatial error models, we can interpret the coefficients directly, as in a conventional linear model. \n\n### SLX\n\nSLX models can either be estimated with `lmSLX()` directly, or by creating $\\bm W \\bm X$ manually and plugging it into any available model-fitting function.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-12_747b15853957530df3cd4e3798946421'}\n\n```{.r .cell-code}\nmod_1.slx <- lmSLX(log(med_house_price) ~ log(no2) + log(POPDEN) + \n                     per_mixed + per_asian + per_black + per_other,  \n                   data = msoa.spdf, \n                   listw = queens.lw, \n                   Durbin = TRUE) # use a formula to lag only specific covariates\nsummary(mod_1.slx)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = formula(paste(\"y ~ \", paste(colnames(x)[-1], collapse = \"+\"))), \n    data = as.data.frame(x), weights = weights)\n\nCoefficients:\n                 Estimate    Std. Error  t value     Pr(>|t|)  \n(Intercept)       1.058e+01   1.539e-01   6.878e+01   0.000e+00\nlog.no2.         -4.407e-01   1.811e-01  -2.434e+00   1.511e-02\nlog.POPDEN.      -7.684e-02   1.734e-02  -4.430e+00   1.049e-05\nper_mixed        -3.304e-02   1.130e-02  -2.925e+00   3.530e-03\nper_asian        -2.381e-03   1.474e-03  -1.615e+00   1.065e-01\nper_black        -1.623e-02   1.801e-03  -9.009e+00   1.080e-18\nper_other        -2.039e-02   6.564e-03  -3.107e+00   1.947e-03\nlag.log.no2.      9.936e-01   1.994e-01   4.984e+00   7.384e-07\nlag.log.POPDEN.   1.133e-01   2.875e-02   3.939e+00   8.759e-05\nlag.per_mixed     1.261e-01   1.429e-02   8.820e+00   5.249e-18\nlag.per_asian    -3.828e-03   1.661e-03  -2.305e+00   2.140e-02\nlag.per_black    -1.805e-02   2.241e-03  -8.056e+00   2.296e-15\nlag.per_other     4.814e-02   7.971e-03   6.039e+00   2.204e-09\n```\n:::\n:::\n\n\n\nIn SLX models, we can simply interpret the coefficients of direct and indirect (spatially lagged) covariates. \n\nFor instance, lets look at population density: \n\n::: callout-tip\n## Interpretaion SLX\n\n1. A high population density in the focal unit is related to lower house prices (a 1% increase in population density decreses house prices by -0.08%), but \n\n2. A high population density in the neighbouring areas is related to higher house prices (while keeping population density in the focal unit constant). A 1% increase in the *average* population density *across the adjacent neighbourhoods* increases house prices in *the focal unit* by 0.11%) \n\nPotential interpretation: areas with a low population density in central regions of the city (high pop density in surrounding neighbourhoods) have higher house prices. We could try testing this interpretation by including the distance to the city centre as a control.\n:::\n\nAlso note how the air pollution coefficient has changed here, with a negative effect in the focal unit and positive one among the neighbouring units.\n\nAn alternative way of estimating the same model is lagging the covariates first.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-13_2e3b4ec46cbe2a40d6baabb9fb3d2c0c'}\n\n```{.r .cell-code}\n# Loop through vars and create lagged variables\nmsoa.spdf$log_POPDEN <- log(msoa.spdf$POPDEN)\nmsoa.spdf$log_no2 <- log(msoa.spdf$no2)\nmsoa.spdf$log_med_house_price <- log(msoa.spdf$med_house_price)\n\nvars <- c(\"log_med_house_price\", \"log_no2\", \"log_POPDEN\", \n          \"per_mixed\", \"per_asian\", \"per_black\", \"per_other\",\n          \"per_owner\", \"per_social\", \"pubs_count\")\nfor(v in vars){\n  msoa.spdf[, paste0(\"w.\", v)] <- lag.listw(queens.lw,\n                                            var = st_drop_geometry(msoa.spdf)[, v])\n}\n\n# Alternatively:\nw_vars <- create_WX(st_drop_geometry(msoa.spdf[, vars]),\n                    listw = queens.lw,\n                    prefix = \"w\")\n\nhead(w_vars)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  w.log_med_house_price w.log_no2 w.log_POPDEN w.per_mixed w.per_asian\n1              12.98382  3.843750     4.662014    4.748368   23.899916\n2              12.28730  3.098960     3.300901    3.978275   19.951593\n3              12.21207  3.206338     4.009795    3.997487   20.793559\n4              12.18176  3.169934     3.630360    2.759082    7.633439\n5              12.11159  3.221203     3.993660    3.930061   12.791140\n6              12.08393  3.217865     3.876070    3.419488    8.997514\n  w.per_black w.per_other w.per_owner w.per_social w.pubs_count\n1    7.879758   3.2080074    25.75738     33.85580    8.5454545\n2   10.451828   1.6368986    66.42278     15.75042    0.6666667\n3   12.965863   1.7526693    58.72637     21.38169    0.2857143\n4   12.135478   0.6992118    66.52519     19.70500    0.2000000\n5   16.108948   1.3817357    53.05539     29.44022    0.4000000\n6   15.312652   0.9611710    59.49460     23.81126    0.1666667\n```\n:::\n:::\n\n\n\nAnd subsequently we use those new variables in a linear model.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-14_d1eb0d9542ea4ec03409a37aea0cda0d'}\n\n```{.r .cell-code}\nmod_1.lm <- lm (log(med_house_price) ~ log(no2) + log(POPDEN) + \n                  per_mixed + per_asian + per_black + per_other +\n                  w.log_no2 + w.log_POPDEN +\n                  w.per_mixed + w.per_asian + w.per_black + w.per_other,\n                data = msoa.spdf)\nsummary(mod_1.lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = log(med_house_price) ~ log(no2) + log(POPDEN) + \n    per_mixed + per_asian + per_black + per_other + w.log_no2 + \n    w.log_POPDEN + w.per_mixed + w.per_asian + w.per_black + \n    w.per_other, data = msoa.spdf)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-0.50809 -0.16605 -0.01817  0.13055  1.09039 \n\nCoefficients:\n              Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  10.582440   0.153862  68.779  < 2e-16 ***\nlog(no2)     -0.440727   0.181063  -2.434  0.01511 *  \nlog(POPDEN)  -0.076840   0.017345  -4.430 1.05e-05 ***\nper_mixed    -0.033042   0.011298  -2.925  0.00353 ** \nper_asian    -0.002381   0.001474  -1.615  0.10655    \nper_black    -0.016229   0.001801  -9.009  < 2e-16 ***\nper_other    -0.020391   0.006564  -3.107  0.00195 ** \nw.log_no2     0.993602   0.199370   4.984 7.38e-07 ***\nw.log_POPDEN  0.113262   0.028752   3.939 8.76e-05 ***\nw.per_mixed   0.126069   0.014294   8.820  < 2e-16 ***\nw.per_asian  -0.003828   0.001661  -2.305  0.02140 *  \nw.per_black  -0.018054   0.002241  -8.056 2.30e-15 ***\nw.per_other   0.048139   0.007971   6.039 2.20e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.2262 on 970 degrees of freedom\nMultiple R-squared:  0.653,\tAdjusted R-squared:  0.6487 \nF-statistic: 152.1 on 12 and 970 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n\nLooks pretty similar to `lmSLX()` results, and it should! A big advantage of the SLX specification is that we can use the lagged variables in basically all methods which take variables as inputs, such as non-linear models, matching algorithms, and machine learning tools.\n\nMoreover, using the lagged variables gives a high degree of freedom. For instance, we could (not saying that it necessarily makes sense):\n\n* Use different weights matrices for different variables\n\n* Include higher order neighbours using `nblag()` (with an increasing number of orders we go towards a more global model, but we estimate a coefficient for each spillover, instead of estimating just one)\n\n* Use machine learning techniques to determine the best fitting weights specification.\n\n\n### SDEM\n\nSDEM models can be estimated using `errorsarlm()` with the additional option `Durbin = TRUE`.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-15_e596a598a0d2af30f28a163a687c06c2'}\n\n```{.r .cell-code}\nmod_1.sdem <- errorsarlm(log(med_house_price) ~ log(no2) + log(POPDEN) +\n                          per_mixed + per_asian + per_black + per_other,  \n                        data = msoa.spdf, \n                        listw = queens.lw,\n                        Durbin = TRUE) # we could here extend to SDEM\nsummary(mod_1.sdem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:errorsarlm(formula = log(med_house_price) ~ log(no2) + log(POPDEN) + \n    per_mixed + per_asian + per_black + per_other, data = msoa.spdf, \n    listw = queens.lw, Durbin = TRUE)\n\nResiduals:\n      Min        1Q    Median        3Q       Max \n-0.617795 -0.106380 -0.014832  0.095826  0.927446 \n\nType: error \nCoefficients: (asymptotic standard errors) \n                  Estimate Std. Error  z value  Pr(>|z|)\n(Intercept)     10.4422703  0.3652148  28.5921 < 2.2e-16\nlog(no2)        -0.2057493  0.1264914  -1.6266 0.1038248\nlog(POPDEN)     -0.0769743  0.0132094  -5.8272 5.635e-09\nper_mixed       -0.0222406  0.0079705  -2.7904 0.0052649\nper_asian       -0.0037484  0.0010054  -3.7284 0.0001927\nper_black       -0.0179751  0.0012383 -14.5161 < 2.2e-16\nper_other       -0.0150218  0.0044895  -3.3460 0.0008199\nlag.log(no2)     1.0004491  0.1739833   5.7503 8.911e-09\nlag.log(POPDEN) -0.0054241  0.0327802  -0.1655 0.8685763\nlag.per_mixed    0.0669699  0.0169349   3.9545 7.668e-05\nlag.per_asian   -0.0018566  0.0015957  -1.1635 0.2446368\nlag.per_black   -0.0079949  0.0024833  -3.2195 0.0012842\nlag.per_other    0.0273378  0.0087430   3.1268 0.0017671\n\nLambda: 0.76173, LR test value: 455.7, p-value: < 2.22e-16\nAsymptotic standard error: 0.024949\n    z-value: 30.531, p-value: < 2.22e-16\nWald statistic: 932.15, p-value: < 2.22e-16\n\nLog likelihood: 300.847 for error model\nML residual variance (sigma squared): 0.027504, (sigma: 0.16584)\nNumber of observations: 983 \nNumber of parameters estimated: 15 \nAIC: -571.69, (AIC for lm: -117.99)\n```\n:::\n:::\n\n\n\nAnd this SDEM can be interpreted like a combination of SEM and SLX. \n\nFirst, we still see highly significant auto-correlation in the error term. However, it's lower in magnitude now that we also include the $\\bm W X$ terms.\n\nSecond, the coefficients tell a similar story as in the SLX (use the same interpretation), but some coefficient magnitudes have become smaller.\n\n\n### SDM\n\nSDM models can be estimated using `lagsarlm()` with the additional option `Durbin = TRUE`.\n\n\n\n::: {.cell hash='05_regression-theory_cache/pdf/unnamed-chunk-16_26a8f4dcde72f1cf684efa5615d2b0d8'}\n\n```{.r .cell-code}\nmod_1.sdm <- lagsarlm(log(med_house_price) ~ log(no2) + log(POPDEN) + \n                        per_mixed + per_asian + per_black + per_other,  \n                      data = msoa.spdf, \n                      listw = queens.lw,\n                      Durbin = TRUE) # we could here extend to SDM\nsummary(mod_1.sdm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:lagsarlm(formula = log(med_house_price) ~ log(no2) + log(POPDEN) + \n    per_mixed + per_asian + per_black + per_other, data = msoa.spdf, \n    listw = queens.lw, Durbin = TRUE)\n\nResiduals:\n      Min        1Q    Median        3Q       Max \n-0.614314 -0.107947 -0.013509  0.092234  0.917398 \n\nType: mixed \nCoefficients: (asymptotic standard errors) \n                  Estimate Std. Error  z value  Pr(>|z|)\n(Intercept)      2.7843426  0.2944721   9.4554 < 2.2e-16\nlog(no2)        -0.3112762  0.1308101  -2.3796 0.0173312\nlog(POPDEN)     -0.0802866  0.0125213  -6.4120 1.436e-10\nper_mixed       -0.0368998  0.0081596  -4.5223 6.118e-06\nper_asian       -0.0033726  0.0010636  -3.1711 0.0015189\nper_black       -0.0159770  0.0013006 -12.2848 < 2.2e-16\nper_other       -0.0209743  0.0047369  -4.4279 9.516e-06\nlag.log(no2)     0.4880923  0.1456778   3.3505 0.0008067\nlag.log(POPDEN)  0.0781188  0.0207600   3.7629 0.0001679\nlag.per_mixed    0.0640880  0.0104646   6.1243 9.110e-10\nlag.per_asian    0.0017665  0.0012101   1.4598 0.1443498\nlag.per_black    0.0070487  0.0017938   3.9295 8.511e-05\nlag.per_other    0.0284822  0.0057774   4.9299 8.226e-07\n\nRho: 0.73126, LR test value: 501.83, p-value: < 2.22e-16\nAsymptotic standard error: 0.025889\n    z-value: 28.246, p-value: < 2.22e-16\nWald statistic: 797.86, p-value: < 2.22e-16\n\nLog likelihood: 323.9111 for mixed model\nML residual variance (sigma squared): 0.026633, (sigma: 0.1632)\nNumber of observations: 983 \nNumber of parameters estimated: 15 \nAIC: -617.82, (AIC for lm: -117.99)\nLM test for residual autocorrelation\ntest value: 36.704, p-value: 1.3747e-09\n```\n:::\n:::\n\n\n\nAnd this SDM can be interpreted like a combination of SAR and SLX. \n\nFirst, there's still substantial auto-correlation in $\\bm y$, and this has become even stronger as compared to SAR.\n\nSecond, we can interpret the direction of the effect, but we *cannot interpret the coefficient as marginal effects*.\n\n<!-- ## Examples -->\n\n<!-- __@Boillat.2022__ -->\n\n<!-- _The paper investigates the effects of protected areas and various land tenure regimes on deforestation and possible spillover effects in Bolivia, a global tropical deforestation hotspot._ -->\n\n<!-- ![](fig/Boillat.png) -->\n\n<!-- _Protected areas – which in Bolivia are all based on co-management schemes - also protect forests in adjacent areas, showing an indirect protective spillover effect. Indigenous lands however only have direct forest protection effects._ -->\n\n<!-- __@Fischer.2009__ -->\n\n<!-- _The focus of this paper is on the role of human capital in explaining labor productivity variation among 198 European regions within a regression framework._ -->\n\n<!-- ![](fig/Fischer.png) -->\n\n<!-- _A ceteris paribus increase in the level of human capital is found to have a significant and positive direct impact. But this positive direct impact is offset by a significant and negative indirect (spillover) impact leading to a total impact that is not significantly different from zero._ -->\n\n<!-- _The intuition here arises from the notion that it is relative regional advantages in human capital that matter most for labor productivity, so changing human capital across all regions should have little or no total impact on (average) labor productivity levels._ -->\n\n<!-- __@Ruttenauer.2018a__ -->\n\n<!-- _This study investigates the presence of environmental inequality in Germany - the connection between the presence of foreign-minority population and objectively measured industrial pollution._ -->\n\n<!-- ![](fig/census.png) -->\n\n<!-- _Results reveal that the share of minorities within a census cell indeed positively correlates with the exposure to industrial pollution. Furthermore, spatial spillover effects are highly relevant: the characteristics of the neighbouring spatial units matter in predicting the amount of pollution. Especially within urban areas, clusters of high minority neighbourhoods are affected by high levels of environmental pollution._ -->\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}