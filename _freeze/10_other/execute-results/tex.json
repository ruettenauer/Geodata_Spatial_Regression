{
  "hash": "2defddfa1269214ba8a1bd55b1e9155e",
  "result": {
    "markdown": "::: {.content-hidden unless-format=\"html\"}\n$$\n\\newcommand{\\tr}{\\mathrm{tr}}\n\\newcommand{\\rank}{\\mathrm{rank}}\n\\newcommand{\\plim}{\\operatornamewithlimits{plim}}\n\\newcommand{\\diag}{\\mathrm{diag}}\n\\newcommand{\\bm}[1]{\\boldsymbol{\\mathbf{#1}}}\n\\newcommand{\\Var}{\\mathrm{Var}}\n\\newcommand{\\Exp}{\\mathrm{E}}\n\\newcommand{\\Cov}{\\mathrm{Cov}}\n\\newcommand\\given[1][]{\\:#1\\vert\\:}\n\\newcommand{\\irow}[1]{%\n\\begin{pmatrix}#1\\end{pmatrix}\n}\n$$\n:::\n\n\\newcommand{\\Prob}{\\mathrm{Prob}}\n\n# Other Models\n\n### Required packages\n\n\n\n::: {.cell hash='10_other_cache/pdf/unnamed-chunk-1_505866324d7f4d281947554ea3377704'}\n\n```{.r .cell-code}\npkgs <- c(\"sf\", \"mapview\", \"spdep\", \"spatialreg\", \"tmap\", \"viridisLite\", \"GWmodel\") # note: load spdep first, then spatialreg\nlapply(pkgs, require, character.only = TRUE)\n```\n:::\n\n\n\n### Session info\n\n\n\n::: {.cell hash='10_other_cache/pdf/unnamed-chunk-2_a7de447e6fc499389a0947e309c037a8'}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.4.1 (2024-06-14 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 22631)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United Kingdom.utf8 \n[2] LC_CTYPE=English_United Kingdom.utf8   \n[3] LC_MONETARY=English_United Kingdom.utf8\n[4] LC_NUMERIC=C                           \n[5] LC_TIME=English_United Kingdom.utf8    \n\ntime zone: Europe/Berlin\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] GWmodel_2.3-2     Rcpp_1.0.12       sp_2.1-4          robustbase_0.99-2\n [5] viridisLite_0.4.2 tmap_3.3-4        spatialreg_1.3-4  Matrix_1.7-0     \n [9] spdep_1.3-5       spData_2.3.1      mapview_2.11.2    sf_1.0-16        \n\nloaded via a namespace (and not attached):\n [1] xfun_0.45          raster_3.6-26      htmlwidgets_1.6.4  lattice_0.22-6    \n [5] tools_4.4.1        crosstalk_1.2.1    LearnBayes_2.15.1  parallel_4.4.1    \n [9] stats4_4.4.1       sandwich_3.1-0     spacetime_1.3-1    proxy_0.4-27      \n[13] DEoptimR_1.1-3     xts_0.14.0         KernSmooth_2.23-24 satellite_1.0.5   \n[17] RColorBrewer_1.1-3 leaflet_2.2.2      lifecycle_1.0.4    FNN_1.1.4         \n[21] compiler_4.4.1     deldir_2.0-4       munsell_0.5.1      terra_1.7-78      \n[25] codetools_0.2-20   leafsync_0.1.0     stars_0.6-5        htmltools_0.5.8.1 \n[29] class_7.3-22       MASS_7.3-60.2      classInt_0.4-10    lwgeom_0.2-14     \n[33] wk_0.9.1           abind_1.4-5        boot_1.3-30        multcomp_1.4-25   \n[37] nlme_3.1-164       digest_0.6.35      mvtnorm_1.2-5      splines_4.4.1     \n[41] fastmap_1.2.0      grid_4.4.1         colorspace_2.1-0   cli_3.6.2         \n[45] magrittr_2.0.3     base64enc_0.1-3    dichromat_2.0-0.1  XML_3.99-0.16.1   \n[49] survival_3.6-4     leafem_0.2.3       TH.data_1.1-2      e1071_1.7-14      \n[53] scales_1.3.0       rmarkdown_2.27     zoo_1.8-12         png_0.1-8         \n[57] coda_0.19-4.1      evaluate_0.24.0    knitr_1.47         tmaptools_3.1-1   \n[61] s2_1.1.6           rlang_1.1.4        glue_1.7.0         DBI_1.2.3         \n[65] rstudioapi_0.16.0  jsonlite_1.8.8     R6_2.5.1           intervals_0.15.4  \n[69] units_0.8-5       \n```\n:::\n:::\n\n\n\n### Reload data from pervious session\n\n\n\n::: {.cell hash='10_other_cache/pdf/unnamed-chunk-3_8caeaefca5ab8c1dc83e66965eceeec5'}\n\n```{.r .cell-code}\nload(\"_data/msoa2_spatial.RData\")\n```\n:::\n\n\n\n\n\n## Geographically weighted regression\n\nDoes the relation between $y$ and $x$ vary depending on the region we are looking at? With geographically weighted regressions (GWR), we can exploit the spatial heterogeneity in relations / coefficients.\n\nGWR [@Brunsdon.1996; @Gollini.2015] is mainly an explorative tool for spatial data analysis in which we estimate an equation at different geographical points. For $L$ given locations across London, we receive $L$ different coefficients.\n\n$$\n\\begin{split} \n\\hat{\\bm \\beta}_l=& ({\\bm X}^\\intercal{\\bm M}_l{\\bm X})^{-1}{\\bm X}^\\intercal{\\bm M}_l{\\bm Y},\n\\end{split}\n$$\n\nThe $N \\times N$ matrix ${\\bm M}_l$ defines the weights at each local point $l$, assigning higher weights to closer units. The local weights are determined by a kernel density function with a pre-determined bandwidth $b$ around each point (either a fixed distance or an adaptive k nearest neighbours bandwidth). Models are estimated via `gwr.basic()` or `gwr.robust()` of the `GWmodel` package.\n\n\n\n::: {.cell hash='10_other_cache/pdf/unnamed-chunk-4_55e566085b65062daa847a9373fa442b'}\n\n```{.r .cell-code}\n# Search for the optimal bandwidth \nset.seed(123)\nhv_1.bw <- bw.gwr(log(med_house_price) ~ log(no2) + log(POPDEN) + pubs_count ,\n                  data = as_Spatial(msoa.spdf),\n                  kernel = \"boxcar\",\n                  adaptive = TRUE) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAdaptive bandwidth: 615 CV score: 117.989 \nAdaptive bandwidth: 388 CV score: 107.5287 \nAdaptive bandwidth: 247 CV score: 89.99347 \nAdaptive bandwidth: 160 CV score: 76.23795 \nAdaptive bandwidth: 106 CV score: 66.39574 \nAdaptive bandwidth: 73 CV score: 62.89816 \nAdaptive bandwidth: 52 CV score: 59.46008 \nAdaptive bandwidth: 39 CV score: 56.70472 \nAdaptive bandwidth: 31 CV score: 54.97107 \nAdaptive bandwidth: 26 CV score: 53.27627 \nAdaptive bandwidth: 23 CV score: 54.23635 \nAdaptive bandwidth: 28 CV score: 54.47944 \nAdaptive bandwidth: 25 CV score: 52.5378 \nAdaptive bandwidth: 24 CV score: 53.74594 \nAdaptive bandwidth: 25 CV score: 52.5378 \n```\n:::\n\n```{.r .cell-code}\nhv_1.bw\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 25\n```\n:::\n\n```{.r .cell-code}\n### GWR \nhv_1.gwr <- gwr.robust(log(med_house_price) ~ log(no2) + log(POPDEN) + pubs_count,\n                      data = as_Spatial(msoa.spdf), \n                      kernel = \"boxcar\", \n                      adaptive = TRUE, \n                      bw = hv_1.bw, \n                      longlat = FALSE)\nprint(hv_1.gwr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   ***********************************************************************\n   *                       Package   GWmodel                             *\n   ***********************************************************************\n   Program starts at: 2024-06-29 17:44:40.25414 \n   Call:\n   gwr.basic(formula = formula, data = data, bw = bw, kernel = kernel, \n    adaptive = adaptive, p = p, theta = theta, longlat = longlat, \n    dMat = dMat, F123.test = F123.test, cv = T, W.vect = W.vect, \n    parallel.method = parallel.method, parallel.arg = parallel.arg)\n\n   Dependent (y) variable:  med_house_price\n   Independent variables:  no2 POPDEN pubs_count\n   Number of data points: 983\n   ***********************************************************************\n   *                    Results of Global Regression                     *\n   ***********************************************************************\n\n   Call:\n    lm(formula = formula, data = data)\n\n   Residuals:\n     Min       1Q   Median       3Q      Max \n-0.90930 -0.24801 -0.05018  0.20925  1.49660 \n\n   Coefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n   (Intercept) 10.630835   0.194980  54.523  < 2e-16 ***\n   log(no2)     0.716116   0.074916   9.559  < 2e-16 ***\n   log(POPDEN) -0.111104   0.023101  -4.809 1.75e-06 ***\n   pubs_count   0.008513   0.004209   2.023   0.0434 *  \n\n   ---Significance stars\n   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 \n   Residual standard error: 0.359 on 979 degrees of freedom\n   Multiple R-squared: 0.1177\n   Adjusted R-squared: 0.115 \n   F-statistic: 43.55 on 3 and 979 DF,  p-value: < 2.2e-16 \n   ***Extra Diagnostic information\n   Residual sum of squares: 126.1498\n   Sigma(hat): 0.3585988\n   AIC:  781.3976\n   AICc:  781.459\n   BIC:  -142.6963\n   ***********************************************************************\n   *          Results of Geographically Weighted Regression              *\n   ***********************************************************************\n\n   *********************Model calibration information*********************\n   Kernel function: boxcar \n   Adaptive bandwidth: 25 (number of nearest neighbours)\n   Regression points: the same locations as observations are used.\n   Distance metric: Euclidean distance metric is used.\n\n   ****************Summary of GWR coefficient estimates:******************\n                     Min.    1st Qu.     Median    3rd Qu.    Max.\n   Intercept   -5.4436033 10.0869061 13.1177690 15.5252567 26.8582\n   log(no2)    -4.0174929 -0.7502331  0.0833824  1.0580475  6.2823\n   log(POPDEN) -0.8610728 -0.3139087 -0.1368702 -0.0200140  0.4031\n   pubs_count  -0.3421595 -0.0252434 -0.0034784  0.0192272  0.2222\n   ************************Diagnostic information*************************\n   Number of data points: 983 \n   Effective number of parameters (2trace(S) - trace(S'S)): 136.1695 \n   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 846.8305 \n   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): -133.0433 \n   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): -316.0801 \n   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): -496.9587 \n   Residual sum of squares: 36.33063 \n   R-square value:  0.7459107 \n   Adjusted R-square value:  0.7050051 \n\n   ***********************************************************************\n   Program stops at: 2024-06-29 17:44:47.805478 \n```\n:::\n:::\n\n\n\nThe results give a range of coefficients for different locations. Let's map those individual coefficients.\n\n\n\n::: {.cell hash='10_other_cache/pdf/unnamed-chunk-5_d34f4c9d5d696592e7611bdb98d09c33'}\n\n```{.r .cell-code}\n# Spatial object\ngwr.spdf <- st_as_sf(hv_1.gwr$SDF)\ngwr.spdf <- st_make_valid(gwr.spdf)\n\n# Map\ntmap_mode(\"view\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\ntmap mode set to interactive viewing\n```\n:::\n\n```{.r .cell-code}\nmp2 <- tm_shape(gwr.spdf) +\n  tm_fill(col = \"log(POPDEN)\", \n          style = \"cont\", \n          # n = 8,\n          title = \"Coefficient\", \n          palette = viridis(100),\n          midpoint = TRUE, stretch.palette = TRUE) +\n  tm_borders(col = \"grey85\") +\n  tm_layout(legend.frame = TRUE, legend.bg.color = TRUE,\n            #legend.position = c(\"right\", \"bottom\"),\n            legend.outside = TRUE,\n            main.title = \"Coefficient of log population density\", \n            main.title.position = \"center\",\n            title.snap.to.legend = TRUE) \n\nmp2 \n```\n\n::: {.cell-output-display}\n![](10_other_files/figure-pdf/unnamed-chunk-5-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nJust from looking at the map, there may be a connection with the undergrpund network - the effect of population density on house values seems to be stronger / more positive where underground connection is weaker?!\n\n\n## Non-Linear Models\n\nModels with endogenous regressors (SAR)\n\n\n- In the literature: mostly spatial probit considered\n\n- Spatial logit rather uncommon (non normally distributed errors)\n\n\n\t\nIssues with non-linear spatial models\n\n- Estimation: with dependent observations, we need to maximize one $n$-dimensional (log-)likelihood instead of a product of $n$ independent distributions\n\n- Estimation challenging and computationally intense\n\n- Hard to interpret due to non-linear effects in non-linear models\n\n\t\n@Elhorst.2017a, @Franzese.2016\n\n### Problem with non-linear models\n\nSpatial-SAR-Probit\n$$\n\t\t{\\bm y^\\star}=\\rho{\\bm W}{\\bm y^\\star}+{\\bm X}{\\bm \\beta}+ {\\bm \\varepsilon} \\\\\t\t\n\t\ty_i = \\{1 \\text{ if } y_i^\\star > 0; 0 \\text{ if } y_i^\\star \\leq 0 \\} \\nonumber\n$$\n\nor in reduced form:\n\t\n$$\n\t\t{\\bm y^\\star}=(\\bm I - \\rho{\\bm W})^{-1}{\\bm X}{\\bm \\beta} + \\bm u \\text{, } \\bm u = (\\bm I - \\rho{\\bm W})^{-1}{\\bm \\varepsilon},\\\\\n\t\t\\text{with } \\bm u \\sim MVN(0, (\\bm I - \\rho{\\bm W})^\\intercal (\\bm I - \\rho{\\bm W})^{-1}) \\nonumber\n$$\n\n- Probability $\\bm y^\\star$ is a latent variable, not observed\n\n- We only observe binary outcome $y_i$\n\n- $\\Cov(y_i, y_j)$ is not the same as $\\Cov(y_i^\\star, y_j^\\star)$\n\n- Error term is heteroskedastic and spatially correlated\n\n\nProbability\n\n$$\n\t\t\\Prob[{\\bm y^\\star}>0]  = \n\t\t\\Prob[(\\bm I - \\rho{\\bm W})^{-1}{\\bm X}{\\bm \\beta} + \n\t\t(\\bm I - \\rho{\\bm W})^{-1}{\\bm \\varepsilon}] \\\\\n\t\t  =  \\Prob[(\\bm I - \\rho{\\bm W})^{-1}{\\bm \\varepsilon} <\n\t\t (\\bm I - \\rho{\\bm W})^{-1}{\\bm X}{\\bm \\beta}] \\nonumber\n$$\n\n\tor in using the observed outcome:\n\t\n$$\n\t\t\\Prob[\\bm y_i=1 | \\bm X]  = \n\t\t\\Prob\\big[u_i <\n\t\t [(\\bm I - \\rho{\\bm W})^{-1}{\\bm X}{\\bm \\beta}]_i\\big] \\\\\n\t\t  = \\bm \\phi\\{[(\\bm I - \\rho{\\bm W})^{-1}{\\bm X}{\\bm \\beta}]_i \n\t\t / \\sigma_{ui}\\} \n$$\n\t\n- $\\bm \\phi\\{\\}$ is an n-dimensional cumulative-normal distribution \n\n- $\\sigma_{ui}$ equals $(\\bm I - \\rho{\\bm W})^\\intercal (\\bm I - \\rho{\\bm W})^{-1})_{ii}$, not constant\n\n- no analytical solution\n\n### Estimation\n\nEstimation methods for Spatial-SAR Probit / Logit\n\n- Expectation Maximization [@McMillen.1992].\n\n- (Linearized) Generalized Methods of Moments [@Klier.2008].\n\n- Recursive Importance Sampling [@Beron.2004].\n\n- Maximum Simulated Likelihood RIS [@Franzese.2016]\n\n- Bayesian approach with Markov Chain Monte Carlo simulations [@LeSage.2009]: R package `spatialprobit`\n\t\nNote that it can be hard to interpret the results. As in the linear case, it is necessary to compute the impacts. However, the `marginal' effects may vary with values of the independent variables and the location [@Lacombe.2018].\n\n### Suggestion\n\n\tIn case you are not familiar with the econometric estimation methods and spatial regression models, don't use non-linear models with AR term. \n\t\n\tIf necessary, I would recommend using `spatialprobit` relying on Bayesian MCMC (set high ndraw and burn-in, e.g. 7500 and 2500).\n\n\n- So far, no `best practice' guide\n\n- No systematic comparison of estimation methods\n\n- In R: Only `spatialprobit` provides impact measures?\n\n- Hard to interpret results\n\nWork-around: If the specification is theoretical plausible, using SLX probit / logit might be a practical solution! \n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}