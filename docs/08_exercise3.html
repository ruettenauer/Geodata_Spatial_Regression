<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Geodata &amp; Spatial Regression - 11&nbsp; Exercises III</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09_spatiotemporal.html" rel="next">
<link href="./08_comparison.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08_exercise3.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Exercises III</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Geodata &amp; Spatial Regression</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ruettenauer/Geodata_Spatial_Regression/" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_refresher.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Refresher</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Manipulation &amp; Visualization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_weights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Relationships W</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_exercise1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Exercises I</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_dependence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Detecting Spatial Dependence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_regression-theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Regression Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_regression-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Spatial Regression Models: Estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_exercise2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Exercises II</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_impacts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial Impacts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Comparing and Selecting Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_exercise3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Exercises III</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_spatiotemporal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatio-temporal models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Other Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#required-packages" id="toc-required-packages" class="nav-link active" data-scroll-target="#required-packages">Required packages</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#reload-data-from-pervious-session" id="toc-reload-data-from-pervious-session" class="nav-link" data-scroll-target="#reload-data-from-pervious-session">Reload data from pervious session</a></li>
  <li>
<a href="#environmental-inequality-continued" id="toc-environmental-inequality-continued" class="nav-link" data-scroll-target="#environmental-inequality-continued"><span class="header-section-number">11.1</span> Environmental inequality (continued)</a>
  <ul class="collapse">
<li><a href="#please-calculate-the-true-multiplier-matrix-of-this-sar-model." id="toc-please-calculate-the-true-multiplier-matrix-of-this-sar-model." class="nav-link" data-scroll-target="#please-calculate-the-true-multiplier-matrix-of-this-sar-model.">1) Please calculate the true multiplier matrix of this SAR model.</a></li>
  <li><a href="#create-an-n-x-n-effects-matrix-for-the-effect-of-the-non-eu-citizens.-what-is-the-effect-of-unit-6-on-unit-10-why-is-this-larger-than-the-effect-of-unit-5-on-unit-8" id="toc-create-an-n-x-n-effects-matrix-for-the-effect-of-the-non-eu-citizens.-what-is-the-effect-of-unit-6-on-unit-10-why-is-this-larger-than-the-effect-of-unit-5-on-unit-8" class="nav-link" data-scroll-target="#create-an-n-x-n-effects-matrix-for-the-effect-of-the-non-eu-citizens.-what-is-the-effect-of-unit-6-on-unit-10-why-is-this-larger-than-the-effect-of-unit-5-on-unit-8">2) Create an N x N effects matrix for the effect of the non-EU citizens. What is the effect of unit 6 on unit 10? Why is this larger than the effect of unit 5 on unit 8?</a></li>
  <li><a href="#calculate-and-interpret-the-summary-impact-measures-of-the-sar-model." id="toc-calculate-and-interpret-the-summary-impact-measures-of-the-sar-model." class="nav-link" data-scroll-target="#calculate-and-interpret-the-summary-impact-measures-of-the-sar-model.">3) Calculate and interpret the summary impact measures of the SAR model.</a></li>
  <li><a href="#is-sar-the-right-model-choice-or-would-you-rather-estimate-a-different-model-please-run-a-durbin-model-and-caculate-its-impact-summary-measures" id="toc-is-sar-the-right-model-choice-or-would-you-rather-estimate-a-different-model-please-run-a-durbin-model-and-caculate-its-impact-summary-measures" class="nav-link" data-scroll-target="#is-sar-the-right-model-choice-or-would-you-rather-estimate-a-different-model-please-run-a-durbin-model-and-caculate-its-impact-summary-measures">4) Is SAR the right model choice or would you rather estimate a different model? Please run a Durbin model and caculate its impact summary measures</a></li>
  <li><a href="#please-repeat-with-a-durbin-error-model.-why-are-the-impacts-here-idenptical-to-the-coefficients" id="toc-please-repeat-with-a-durbin-error-model.-why-are-the-impacts-here-idenptical-to-the-coefficients" class="nav-link" data-scroll-target="#please-repeat-with-a-durbin-error-model.-why-are-the-impacts-here-idenptical-to-the-coefficients">5) Please repeat with a Durbin Error model. Why are the impacts here idenptical to the coefficients?</a></li>
  </ul>
</li>
  <li><a href="#inkar-data-the-effect-of-regional-characteristics-on-life-expectancy" id="toc-inkar-data-the-effect-of-regional-characteristics-on-life-expectancy" class="nav-link" data-scroll-target="#inkar-data-the-effect-of-regional-characteristics-on-life-expectancy"><span class="header-section-number">11.2</span> Inkar data: the effect of regional characteristics on life expectancy</a></li>
  <li>
<a href="#county-shapes" id="toc-county-shapes" class="nav-link" data-scroll-target="#county-shapes"><span class="header-section-number">11.3</span> County shapes</a>
  <ul class="collapse">
<li><a href="#please-map-the-life-expectancy-across-germany" id="toc-please-map-the-life-expectancy-across-germany" class="nav-link" data-scroll-target="#please-map-the-life-expectancy-across-germany">1) Please map the life expectancy across Germany</a></li>
  <li><a href="#chose-some-variables-that-could-predict-life-expectancy.-see-for-instance-the-following-paper." id="toc-chose-some-variables-that-could-predict-life-expectancy.-see-for-instance-the-following-paper." class="nav-link" data-scroll-target="#chose-some-variables-that-could-predict-life-expectancy.-see-for-instance-the-following-paper.">2) Chose some variables that could predict life expectancy. See for instance the following paper.</a></li>
  <li><a href="#generate-a-neighbours-object-e.g.-the-10-nearest-neighbours." id="toc-generate-a-neighbours-object-e.g.-the-10-nearest-neighbours." class="nav-link" data-scroll-target="#generate-a-neighbours-object-e.g.-the-10-nearest-neighbours.">3) Generate a neighbours object (e.g.&nbsp;the 10 nearest neighbours).</a></li>
  <li><a href="#estimate-a-cross-sectional-spatial-model-for-the-year-2020-and-calculate-the-impacts." id="toc-estimate-a-cross-sectional-spatial-model-for-the-year-2020-and-calculate-the-impacts." class="nav-link" data-scroll-target="#estimate-a-cross-sectional-spatial-model-for-the-year-2020-and-calculate-the-impacts.">4) Estimate a cross-sectional spatial model for the year 2020 and calculate the impacts.</a></li>
  <li><a href="#calculate-the-spatial-lagged-variables-for-your-covariates-e.g.-use-create_wx-which-needs-a-non-spatial-df-as-input-." id="toc-calculate-the-spatial-lagged-variables-for-your-covariates-e.g.-use-create_wx-which-needs-a-non-spatial-df-as-input-." class="nav-link" data-scroll-target="#calculate-the-spatial-lagged-variables-for-your-covariates-e.g.-use-create_wx-which-needs-a-non-spatial-df-as-input-.">5) Calculate the spatial lagged variables for your covariates (e.g.&nbsp;use create_WX(), which needs a non-spatial df as input) .</a></li>
  <li><a href="#can-you-run-a-spatial-machine-learning-model-for-instance-using-randomforest" id="toc-can-you-run-a-spatial-machine-learning-model-for-instance-using-randomforest" class="nav-link" data-scroll-target="#can-you-run-a-spatial-machine-learning-model-for-instance-using-randomforest">6) Can you run a spatial machine learning model? (for instance, using <code>randomForest</code>)?</a></li>
  </ul>
</li>
  <li><a href="#esimate-an-fe-model-with-slx-specification" id="toc-esimate-an-fe-model-with-slx-specification" class="nav-link" data-scroll-target="#esimate-an-fe-model-with-slx-specification"><span class="header-section-number">11.4</span> Esimate an FE model with SLX specification</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Exercises III</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p><span class="math display">\[
\newcommand{\tr}{\mathrm{tr}}
\newcommand{\rank}{\mathrm{rank}}
\newcommand{\plim}{\operatornamewithlimits{plim}}
\newcommand{\diag}{\mathrm{diag}}
\newcommand{\bm}[1]{\boldsymbol{\mathbf{#1}}}
\newcommand{\Var}{\mathrm{Var}}
\newcommand{\Exp}{\mathrm{E}}
\newcommand{\Cov}{\mathrm{Cov}}
\newcommand\given[1][]{\:#1\vert\:}
\newcommand{\irow}[1]{%
\begin{pmatrix}#1\end{pmatrix}
}
\]</span></p>
<section id="required-packages" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="required-packages">Required packages</h3>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sf"</span>, <span class="st">"mapview"</span>, <span class="st">"spdep"</span>, <span class="st">"spatialreg"</span>, <span class="st">"ggplot2"</span>, <span class="st">"tmap"</span>, <span class="st">"viridis"</span>, <span class="st">"viridisLite"</span>, </span>
<span>          <span class="st">"plm"</span>, <span class="st">"lfe"</span>, <span class="st">"splm"</span>, <span class="st">"SDPDmod"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">pkgs</span>, <span class="va">require</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="session-info" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="session-info">Session info</h3>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 22631)

Matrix products: default
  LAPACK version 3.12.1

locale:
[1] LC_COLLATE=English_United Kingdom.utf8 
[2] LC_CTYPE=English_United Kingdom.utf8   
[3] LC_MONETARY=English_United Kingdom.utf8
[4] LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

time zone: Europe/Berlin
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods  
[7] base     

other attached packages:
 [1] SDPDmod_0.0.6     splm_1.6-5        lfe_3.1.1        
 [4] plm_2.6-6         viridis_0.6.5     viridisLite_0.4.2
 [7] tmap_4.1          ggplot2_3.5.2     spatialreg_1.3-6 
[10] Matrix_1.7-3      spdep_1.3-13      spData_2.3.4     
[13] mapview_2.11.2    sf_1.0-21        

loaded via a namespace (and not attached):
 [1] Rdpack_2.6.4            DBI_1.2.3              
 [3] deldir_2.0-4            gridExtra_2.3          
 [5] tmaptools_3.2           s2_1.1.9               
 [7] logger_0.4.0            sandwich_3.1-1         
 [9] rlang_1.1.6             magrittr_2.0.3         
[11] multcomp_1.4-28         e1071_1.7-16           
[13] compiler_4.5.1          png_0.1-8              
[15] vctrs_0.6.5             stringr_1.5.1          
[17] pkgconfig_2.0.3         wk_0.9.4               
[19] fastmap_1.2.0           lwgeom_0.2-14          
[21] leafem_0.2.4            rmarkdown_2.29         
[23] spacesXYZ_1.6-0         miscTools_0.6-28       
[25] xfun_0.52               satellite_1.0.5        
[27] jsonlite_2.0.0          collapse_2.1.2         
[29] terra_1.8-54            parallel_4.5.1         
[31] LearnBayes_2.15.1       R6_2.6.1               
[33] stringi_1.8.7           RColorBrewer_1.1-3     
[35] boot_1.3-31             lmtest_0.9-40          
[37] stars_0.6-8             Rcpp_1.0.14            
[39] knitr_1.50              zoo_1.8-14             
[41] base64enc_0.1-3         leaflet.providers_2.0.0
[43] splines_4.5.1           tidyselect_1.2.1       
[45] rstudioapi_0.17.1       dichromat_2.0-0.1      
[47] abind_1.4-8             maptiles_0.10.0        
[49] maxLik_1.5-2.1          codetools_0.2-20       
[51] lattice_0.22-7          tibble_3.3.0           
[53] leafsync_0.1.0          withr_3.0.2            
[55] coda_0.19-4.1           evaluate_1.0.4         
[57] survival_3.8-3          units_0.8-7            
[59] proxy_0.4-27            pillar_1.10.2          
[61] KernSmooth_2.23-26      stats4_4.5.1           
[63] generics_0.1.4          sp_2.2-0               
[65] scales_1.4.0            xtable_1.8-4           
[67] class_7.3-23            glue_1.8.0             
[69] tools_4.5.1             leaflegend_1.2.1       
[71] data.table_1.17.6       RSpectra_0.16-2        
[73] dotCall64_1.2           mvtnorm_1.3-3          
[75] XML_3.99-0.18           grid_4.5.1             
[77] rbibutils_2.3           crosstalk_1.2.1        
[79] bdsmatrix_1.3-7         colorspace_2.1-1       
[81] nlme_3.1-168            cols4all_0.8           
[83] raster_3.6-32           Formula_1.2-5          
[85] cli_3.6.5               spam_2.11-1            
[87] dplyr_1.1.4             gtable_0.3.6           
[89] digest_0.6.37           classInt_0.4-11        
[91] TH.data_1.1-3           htmlwidgets_1.6.4      
[93] farver_2.1.2            htmltools_0.5.8.1      
[95] lifecycle_1.0.4         leaflet_2.2.2          
[97] MASS_7.3-65            </code></pre>
</div>
</div>
</section><section id="reload-data-from-pervious-session" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="reload-data-from-pervious-session">Reload data from pervious session</h3>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"_data/msoa2_spatial.RData"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="environmental-inequality-continued" class="level2" data-number="11.1"><h2 data-number="11.1" class="anchored" data-anchor-id="environmental-inequality-continued">
<span class="header-section-number">11.1</span> Environmental inequality (continued)</h2>
<p>Letâ€™s use the same neighbours weights definition as before:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">st_centroid</span><span class="op">(</span><span class="va">msoa.spdf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over
geometries</code></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Neighbours within 3km distance</span></span>
<span><span class="va">dist_15.nb</span> <span class="op">&lt;-</span> <span class="fu">dnearneigh</span><span class="op">(</span><span class="va">coords</span>, d1 <span class="op">=</span> <span class="fl">0</span>, d2 <span class="op">=</span> <span class="fl">2500</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dnearneigh(coords, d1 = 0, d2 = 2500): neighbour object
has 6 sub-graphs</code></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">dist_15.nb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 983 
Number of nonzero links: 15266 
Percentage nonzero weights: 1.579859 
Average number of links: 15.53001 
4 regions with no links:
158, 463, 478, 505
6 disjoint connected subgraphs
Link number distribution:

 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 
 4  5  9 23 19 26 36 31 53 39 61 63 59 48 42 35 24 31 28 30 27 26 
22 23 24 25 26 27 28 29 30 31 32 33 34 
25 19 38 29 32 38 26 16 20 10  8  1  2 
5 least connected regions:
160 469 474 597 959 with 1 link
2 most connected regions:
565 567 with 34 links</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># There are some empty neighbour sets. Lets impute those with the nearest neighbour.</span></span>
<span><span class="va">k2.nb</span> <span class="op">&lt;-</span> <span class="fu">knearneigh</span><span class="op">(</span><span class="va">coords</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Replace zero</span></span>
<span><span class="va">nolink_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">card</span><span class="op">(</span><span class="va">dist_15.nb</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">dist_15.nb</span><span class="op">[</span><span class="fu">card</span><span class="op">(</span><span class="va">dist_15.nb</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">k2.nb</span><span class="op">$</span><span class="va">nn</span><span class="op">[</span><span class="va">nolink_ids</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">dist_15.nb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 983 
Number of nonzero links: 15270 
Percentage nonzero weights: 1.580273 
Average number of links: 15.53408 
6 disjoint connected subgraphs
Link number distribution:

 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 
 9  9 23 19 26 36 31 53 39 61 63 59 48 42 35 24 31 28 30 27 26 25 
23 24 25 26 27 28 29 30 31 32 33 34 
19 38 29 32 38 26 16 20 10  8  1  2 
9 least connected regions:
158 160 463 469 474 478 505 597 959 with 1 link
2 most connected regions:
565 567 with 34 links</code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># listw object with row-normalization</span></span>
<span><span class="va">dist_15.lw</span> <span class="op">&lt;-</span> <span class="fu">nb2listw</span><span class="op">(</span><span class="va">dist_15.nb</span>, style <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and estiamte the spatial SAR model:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mod_1.sar</span> <span class="op">&lt;-</span> <span class="fu">lagsarlm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">no2</span><span class="op">)</span> <span class="op">~</span> <span class="va">per_mixed</span> <span class="op">+</span> <span class="va">per_asian</span> <span class="op">+</span> <span class="va">per_black</span> <span class="op">+</span> <span class="va">per_other</span></span>
<span>                      <span class="op">+</span> <span class="va">per_nonUK_EU</span> <span class="op">+</span> <span class="va">per_nonEU</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">POPDEN</span><span class="op">)</span>,  </span>
<span>                      data <span class="op">=</span> <span class="va">msoa.spdf</span>, </span>
<span>                      listw <span class="op">=</span> <span class="va">dist_15.lw</span>,</span>
<span>                      Durbin <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># we could here extend to SDM</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.sar</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lagsarlm(formula = log(no2) ~ per_mixed + per_asian + per_black + 
    per_other + per_nonUK_EU + per_nonEU + log(POPDEN), data = msoa.spdf, 
    listw = dist_15.lw, Durbin = FALSE)

Residuals:
       Min         1Q     Median         3Q        Max 
-0.2140485 -0.0267085 -0.0021421  0.0238337  0.3505513 

Type: lag 
Coefficients: (asymptotic standard errors) 
                Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)  -1.7004e-02  1.8122e-02 -0.9383  0.348110
per_mixed     3.4376e-04  1.4758e-03  0.2329  0.815810
per_asian    -8.5205e-05  1.1494e-04 -0.7413  0.458507
per_black    -4.2754e-04  2.3468e-04 -1.8218  0.068484
per_other     1.9693e-03  7.4939e-04  2.6279  0.008591
per_nonUK_EU  8.9027e-04  3.9638e-04  2.2460  0.024703
per_nonEU     1.8460e-03  3.5159e-04  5.2506 1.516e-07
log(POPDEN)   1.8650e-02  2.7852e-03  6.6963 2.138e-11

Rho: 0.9684, LR test value: 2002.5, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.0063124
    z-value: 153.41, p-value: &lt; 2.22e-16
Wald statistic: 23535, p-value: &lt; 2.22e-16

Log likelihood: 1562.401 for lag model
ML residual variance (sigma squared): 0.0020568, (sigma: 0.045352)
Number of observations: 983 
Number of parameters estimated: 10 
AIC: -3104.8, (AIC for lm: -1104.3)
LM test for residual autocorrelation
test value: 108.97, p-value: &lt; 2.22e-16</code></pre>
</div>
</div>
<section id="please-calculate-the-true-multiplier-matrix-of-this-sar-model." class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="please-calculate-the-true-multiplier-matrix-of-this-sar-model.">1) Please calculate the true multiplier matrix of this SAR model.</h3>
<p>The multiplier matrix is given by <span class="math inline">\(({\bm I_N}-\rho {\bm W})^{-1}\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu">listw2mat</span><span class="op">(</span><span class="va">dist_15.lw</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">mod_1.sar</span><span class="op">$</span><span class="va">rho</span><span class="op">)</span></span>
<span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span><span class="op">*</span><span class="va">W</span><span class="op">)</span></span>
<span></span>
<span><span class="va">M</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             1           2           3           4           5
1  1.164650997 0.002433319 0.004089559 0.004034508 0.006545994
2  0.010706605 1.407336301 0.643881932 0.370049927 0.464794934
3  0.011246286 0.402426207 1.474021599 0.429011868 0.641526285
4  0.008875918 0.185024963 0.343209495 1.684533322 0.614086824
5  0.012000989 0.193664556 0.427684190 0.511739020 1.560840834
6  0.010741524 0.192552594 0.452940016 0.631452476 0.672787841
7  0.012779708 0.141953871 0.299247377 0.418234186 0.616895800
8  0.014769006 0.125781189 0.253122442 0.295553039 0.500919513
9  0.011708131 0.147549264 0.309080773 0.568442619 0.629156269
10 0.009937859 0.152900148 0.306652041 0.727001926 0.553973310
             6           7          8           9          10
1  0.004882511 0.005808958 0.00872714 0.005854065 0.003613767
2  0.385105188 0.283907742 0.32703109 0.324608380 0.244640237
3  0.566175019 0.374059222 0.41132397 0.424986063 0.306652041
4  0.631452476 0.418234186 0.38421895 0.625286881 0.581601541
5  0.560656534 0.514079833 0.54266281 0.576726580 0.369315540
6  1.571175245 0.558170218 0.46513922 0.661184961 0.543820047
7  0.558170218 1.475511568 0.58520461 0.614170880 0.463886540
8  0.357799398 0.450157392 1.46638195 0.474994894 0.272339890
9  0.601077237 0.558337164 0.56135760 1.581077095 0.517983092
10 0.679775059 0.579858175 0.44255232 0.712226751 1.560083138</code></pre>
</div>
</div>
</section><section id="create-an-n-x-n-effects-matrix-for-the-effect-of-the-non-eu-citizens.-what-is-the-effect-of-unit-6-on-unit-10-why-is-this-larger-than-the-effect-of-unit-5-on-unit-8" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="create-an-n-x-n-effects-matrix-for-the-effect-of-the-non-eu-citizens.-what-is-the-effect-of-unit-6-on-unit-10-why-is-this-larger-than-the-effect-of-unit-5-on-unit-8">2) Create an N x N effects matrix for the effect of the non-EU citizens. What is the effect of unit 6 on unit 10? Why is this larger than the effect of unit 5 on unit 8?</h3>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># For beta 1</span></span>
<span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">mod_1.sar</span><span class="op">$</span><span class="va">coefficients</span></span>
<span></span>
<span><span class="va">effM</span> <span class="op">&lt;-</span> <span class="va">beta</span><span class="op">[</span><span class="st">"per_nonEU"</span><span class="op">]</span> <span class="op">*</span> <span class="va">M</span></span>
<span></span>
<span><span class="va">effM</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              1            2            3            4            5
1  2.149995e-03 4.492010e-06 7.549498e-06 7.447872e-06 1.208418e-05
2  1.976484e-05 2.598002e-03 1.188633e-03 6.831278e-04 8.580311e-04
3  2.076112e-05 7.428958e-04 2.721106e-03 7.919740e-04 1.184285e-03
4  1.638532e-05 3.415639e-04 6.335792e-04 3.109720e-03 1.133630e-03
5  2.215433e-05 3.575129e-04 7.895231e-04 9.446918e-04 2.881378e-03
6  1.982931e-05 3.554602e-04 8.361464e-04 1.165688e-03 1.241995e-03
7  2.359188e-05 2.620528e-04 5.524233e-04 7.720780e-04 1.138816e-03
8  2.726421e-05 2.321974e-04 4.672747e-04 5.456034e-04 9.247186e-04
9  2.161370e-05 2.723822e-04 5.705762e-04 1.049369e-03 1.161449e-03
10 1.834571e-05 2.822601e-04 5.660926e-04 1.342076e-03 1.022658e-03
              6            7            8            9           10
1  9.013321e-06 1.072358e-05 1.611067e-05 1.080685e-05 6.671166e-06
2  7.109204e-04 5.241057e-04 6.037132e-04 5.992408e-04 4.516162e-04
3  1.045183e-03 6.905291e-04 7.593214e-04 7.845422e-04 5.660926e-04
4  1.165688e-03 7.720780e-04 7.092844e-04 1.154306e-03 1.073661e-03
5  1.034996e-03 9.490131e-04 1.001778e-03 1.064662e-03 6.817721e-04
6  2.900456e-03 1.030406e-03 8.586666e-04 1.220575e-03 1.003915e-03
7  1.030406e-03 2.723857e-03 1.080312e-03 1.133785e-03 8.563541e-04
8  6.605128e-04 8.310095e-04 2.707003e-03 8.768606e-04 5.027509e-04
9  1.109614e-03 1.030714e-03 1.036290e-03 2.918735e-03 9.562187e-04
10 1.254893e-03 1.070443e-03 8.169703e-04 1.314801e-03 2.879979e-03</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># "Effect" of unit 6 on unit 10</span></span>
<span><span class="va">effM</span><span class="op">[</span><span class="fl">10</span>, <span class="fl">6</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.001254893</code></pre>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># "Effect" of unit 5 on unit 8</span></span>
<span><span class="va">effM</span><span class="op">[</span><span class="fl">8</span>, <span class="fl">5</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0009247186</code></pre>
</div>
</div>
</section><section id="calculate-and-interpret-the-summary-impact-measures-of-the-sar-model." class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="calculate-and-interpret-the-summary-impact-measures-of-the-sar-model.">3) Calculate and interpret the summary impact measures of the SAR model.</h3>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mod_1.sar.imp</span> <span class="op">&lt;-</span> <span class="fu">impacts</span><span class="op">(</span><span class="va">mod_1.sar</span>, listw <span class="op">=</span> <span class="va">dist_15.lw</span>, R <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.sar.imp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (lag, exact):
                    Direct     Indirect        Total
per_mixed     0.0004939013  0.010385844  0.010879745
per_asian    -0.0001224192 -0.002574253 -0.002696672
per_black    -0.0006142789 -0.012917166 -0.013531445
per_other     0.0028294759  0.059498722  0.062328198
per_nonUK_EU  0.0012791011  0.026897166  0.028176267
per_nonEU     0.0026523198  0.055773451  0.058425770
log(POPDEN)   0.0267960076  0.563471199  0.590267206
========================================================
Simulation results ( variance matrix):
Direct:

Iterations = 1:300
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 300 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

                   Mean        SD  Naive SE Time-series SE
per_mixed     0.0003955 0.0020514 1.184e-04      9.130e-05
per_asian    -0.0001260 0.0001637 9.451e-06      9.451e-06
per_black    -0.0006107 0.0003414 1.971e-05      2.185e-05
per_other     0.0027690 0.0010486 6.054e-05      6.054e-05
per_nonUK_EU  0.0012574 0.0005128 2.961e-05      3.742e-05
per_nonEU     0.0026802 0.0005208 3.007e-05      3.007e-05
log(POPDEN)   0.0272447 0.0035162 2.030e-04      1.873e-04

2. Quantiles for each variable:

                   2.5%        25%        50%        75%     97.5%
per_mixed    -0.0035491 -0.0009365  0.0004515  1.689e-03 4.338e-03
per_asian    -0.0004513 -0.0002480 -0.0001320 -7.792e-06 2.074e-04
per_black    -0.0012931 -0.0008387 -0.0005998 -3.887e-04 3.045e-05
per_other     0.0007558  0.0021335  0.0027984  3.463e-03 4.645e-03
per_nonUK_EU  0.0001030  0.0009395  0.0012639  1.598e-03 2.282e-03
per_nonEU     0.0017652  0.0023047  0.0026757  3.026e-03 3.661e-03
log(POPDEN)   0.0202881  0.0246183  0.0275154  2.969e-02 3.335e-02

========================================================
Indirect:

Iterations = 1:300
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 300 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

                  Mean       SD  Naive SE Time-series SE
per_mixed     0.007473 0.047148 0.0027221      0.0020687
per_asian    -0.002823 0.003704 0.0002138      0.0002138
per_black    -0.013241 0.008237 0.0004756      0.0004756
per_other     0.059451 0.024620 0.0014214      0.0014214
per_nonUK_EU  0.026676 0.011237 0.0006488      0.0006488
per_nonEU     0.058351 0.017870 0.0010317      0.0009293
log(POPDEN)   0.586124 0.128016 0.0073910      0.0073910

2. Quantiles for each variable:

                  2.5%       25%       50%        75%     97.5%
per_mixed    -0.087208 -0.020030  0.010085  0.0360970 0.1017574
per_asian    -0.010475 -0.005587 -0.002511 -0.0001578 0.0041606
per_black    -0.031040 -0.018548 -0.012724 -0.0077485 0.0006373
per_other     0.014713  0.044251  0.057154  0.0742144 0.1138602
per_nonUK_EU  0.002563  0.019605  0.026637  0.0344823 0.0495324
per_nonEU     0.033019  0.044297  0.056318  0.0691705 0.0980183
log(POPDEN)   0.381359  0.506172  0.561225  0.6496823 0.8681111

========================================================
Total:

Iterations = 1:300
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 300 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

                  Mean       SD Naive SE Time-series SE
per_mixed     0.007869 0.049159 0.002838      0.0021569
per_asian    -0.002949 0.003863 0.000223      0.0002230
per_black    -0.013852 0.008556 0.000494      0.0004940
per_other     0.062220 0.025543 0.001475      0.0014747
per_nonUK_EU  0.027934 0.011692 0.000675      0.0006750
per_nonEU     0.061032 0.018276 0.001055      0.0009504
log(POPDEN)   0.613368 0.129770 0.007492      0.0074923

2. Quantiles for each variable:

                  2.5%       25%       50%        75%    97.5%
per_mixed    -0.090560 -0.021083  0.010707  0.0377794 0.106124
per_asian    -0.010927 -0.005828 -0.002638 -0.0001644 0.004364
per_black    -0.032223 -0.019289 -0.013337 -0.0081507 0.000671
per_other     0.015469  0.046374  0.059926  0.0779057 0.118405
per_nonUK_EU  0.002666  0.020685  0.027950  0.0360264 0.051264
per_nonEU     0.034888  0.046503  0.059122  0.0721772 0.101514
log(POPDEN)   0.403963  0.533658  0.588655  0.6803889 0.897901</code></pre>
</div>
</div>
</section><section id="is-sar-the-right-model-choice-or-would-you-rather-estimate-a-different-model-please-run-a-durbin-model-and-caculate-its-impact-summary-measures" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="is-sar-the-right-model-choice-or-would-you-rather-estimate-a-different-model-please-run-a-durbin-model-and-caculate-its-impact-summary-measures">4) Is SAR the right model choice or would you rather estimate a different model? Please run a Durbin model and caculate its impact summary measures</h3>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Spatial Dubrbin model</span></span>
<span><span class="va">mod_1.durb</span> <span class="op">&lt;-</span> <span class="fu">lagsarlm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">no2</span><span class="op">)</span> <span class="op">~</span> <span class="va">per_mixed</span> <span class="op">+</span> <span class="va">per_asian</span> <span class="op">+</span> <span class="va">per_black</span> <span class="op">+</span> <span class="va">per_other</span></span>
<span>                      <span class="op">+</span> <span class="va">per_nonUK_EU</span> <span class="op">+</span> <span class="va">per_nonEU</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">POPDEN</span><span class="op">)</span>,  </span>
<span>                      data <span class="op">=</span> <span class="va">msoa.spdf</span>, </span>
<span>                      listw <span class="op">=</span> <span class="va">dist_15.lw</span>,</span>
<span>                      Durbin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.durb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lagsarlm(formula = log(no2) ~ per_mixed + per_asian + per_black + 
    per_other + per_nonUK_EU + per_nonEU + log(POPDEN), data = msoa.spdf, 
    listw = dist_15.lw, Durbin = TRUE)

Residuals:
       Min         1Q     Median         3Q        Max 
-0.1854009 -0.0263818 -0.0020816  0.0229647  0.3321974 

Type: mixed 
Coefficients: (asymptotic standard errors) 
                    Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)      -0.00409824  0.01983728 -0.2066   0.83633
per_mixed         0.00434535  0.00218712  1.9868   0.04695
per_asian        -0.00028620  0.00023959 -1.1945   0.23227
per_black        -0.00056734  0.00034455 -1.6466   0.09964
per_other         0.00222708  0.00112918  1.9723   0.04857
per_nonUK_EU      0.00085417  0.00059478  1.4361   0.15097
per_nonEU         0.00095220  0.00052681  1.8075   0.07069
log(POPDEN)       0.02649122  0.00320358  8.2693 2.220e-16
lag.per_mixed    -0.00475294  0.00315799 -1.5051   0.13231
lag.per_asian     0.00024092  0.00028983  0.8312   0.40584
lag.per_black     0.00025812  0.00054125  0.4769   0.63344
lag.per_other    -0.00074506  0.00176141 -0.4230   0.67230
lag.per_nonUK_EU  0.00094549  0.00100320  0.9425   0.34595
lag.per_nonEU     0.00130970  0.00078547  1.6674   0.09544
lag.log(POPDEN)  -0.02526415  0.00588517 -4.2928 1.764e-05

Rho: 0.98286, LR test value: 1536.9, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.0051804
    z-value: 189.73, p-value: &lt; 2.22e-16
Wald statistic: 35997, p-value: &lt; 2.22e-16

Log likelihood: 1576.566 for mixed model
ML residual variance (sigma squared): 0.001969, (sigma: 0.044374)
Number of observations: 983 
Number of parameters estimated: 17 
AIC: -3119.1, (AIC for lm: -1584.3)
LM test for residual autocorrelation
test value: 103.97, p-value: &lt; 2.22e-16</code></pre>
</div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Impact measures of the Durbin Error model</span></span>
<span><span class="va">mod_1.durb.imp</span> <span class="op">&lt;-</span> <span class="fu">impacts</span><span class="op">(</span><span class="va">mod_1.durb</span>, listw <span class="op">=</span> <span class="va">dist_15.lw</span>, R <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.durb.imp</span>, zstats <span class="op">=</span> <span class="cn">TRUE</span>, short <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (mixed, exact):
                    Direct     Indirect        Total
per_mixed     0.0040597904 -0.027843988 -0.023784197
per_asian    -0.0003101210 -0.002332322 -0.002642443
per_black    -0.0007447486 -0.017299184 -0.018043932
per_other     0.0030823781  0.083398408  0.086480787
per_nonUK_EU  0.0019115634  0.103104372  0.105015935
per_nonEU     0.0022824096  0.129706442  0.131988851
log(POPDEN)   0.0269491699  0.044653927  0.071603096
========================================================
Simulation results ( variance matrix):
========================================================
Simulated standard errors
                   Direct    Indirect       Total
per_mixed    0.0024339363 0.141825505 0.142745285
per_asian    0.0002358806 0.009566588 0.009608176
per_black    0.0003538376 0.024659362 0.024828224
per_other    0.0012492046 0.078285397 0.078805334
per_nonUK_EU 0.0007003029 0.061007228 0.061381860
per_nonEU    0.0006015436 0.061945576 0.062257328
log(POPDEN)  0.0043279256 0.360475881 0.363229809

Simulated z-values:
                Direct   Indirect      Total
per_mixed     1.656637 -0.2453045 -0.2154767
per_asian    -1.386515 -0.3517739 -0.3842902
per_black    -2.061782 -0.7027223 -0.7273263
per_other     2.474371  1.1662018  1.1977307
per_nonUK_EU  2.765366  1.7525849  1.7734383
per_nonEU     3.807126  2.2494601  2.2749813
log(POPDEN)   6.220852  0.1141200  0.1873770

Simulated p-values:
             Direct     Indirect Total   
per_mixed    0.09759283 0.806221 0.829396
per_asian    0.16558968 0.725008 0.700763
per_black    0.03922853 0.482229 0.467026
per_other    0.01334709 0.243533 0.231022
per_nonUK_EU 0.00568590 0.079673 0.076156
per_nonEU    0.00014059 0.024483 0.022907
log(POPDEN)  4.9446e-10 0.909143 0.851365</code></pre>
</div>
</div>
</section><section id="please-repeat-with-a-durbin-error-model.-why-are-the-impacts-here-idenptical-to-the-coefficients" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="please-repeat-with-a-durbin-error-model.-why-are-the-impacts-here-idenptical-to-the-coefficients">5) Please repeat with a Durbin Error model. Why are the impacts here idenptical to the coefficients?</h3>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Spatial Dubrbin model</span></span>
<span><span class="va">mod_1.durbe</span> <span class="op">&lt;-</span> <span class="fu">errorsarlm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">no2</span><span class="op">)</span> <span class="op">~</span> <span class="va">per_mixed</span> <span class="op">+</span> <span class="va">per_asian</span> <span class="op">+</span> <span class="va">per_black</span> <span class="op">+</span> <span class="va">per_other</span></span>
<span>                      <span class="op">+</span> <span class="va">per_nonUK_EU</span> <span class="op">+</span> <span class="va">per_nonEU</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">POPDEN</span><span class="op">)</span>,  </span>
<span>                      data <span class="op">=</span> <span class="va">msoa.spdf</span>, </span>
<span>                      listw <span class="op">=</span> <span class="va">dist_15.lw</span>,</span>
<span>                      Durbin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.durbe</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
errorsarlm(formula = log(no2) ~ per_mixed + per_asian + per_black + 
    per_other + per_nonUK_EU + per_nonEU + log(POPDEN), data = msoa.spdf, 
    listw = dist_15.lw, Durbin = TRUE)

Residuals:
       Min         1Q     Median         3Q        Max 
-0.1839285 -0.0254426 -0.0027042  0.0216084  0.2944840 

Type: error 
Coefficients: (asymptotic standard errors) 
                    Estimate  Std. Error z value  Pr(&gt;|z|)
(Intercept)       2.64939215  0.24748370 10.7053 &lt; 2.2e-16
per_mixed         0.00553333  0.00223688  2.4737  0.013373
per_asian        -0.00017156  0.00024183 -0.7094  0.478062
per_black        -0.00057947  0.00034426 -1.6832  0.092334
per_other         0.00203392  0.00112534  1.8074  0.070701
per_nonUK_EU      0.00086254  0.00058902  1.4644  0.143091
per_nonEU         0.00135822  0.00053480  2.5397  0.011096
log(POPDEN)       0.02716824  0.00354239  7.6695 1.732e-14
lag.per_mixed     0.00107140  0.00819322  0.1308  0.895960
lag.per_asian    -0.00060616  0.00070080 -0.8649  0.387069
lag.per_black    -0.00191733  0.00130997 -1.4636  0.143291
lag.per_other     0.01014125  0.00496979  2.0406  0.041293
lag.per_nonUK_EU  0.00925620  0.00217624  4.2533 2.106e-05
lag.per_nonEU     0.00563564  0.00185541  3.0374  0.002386
lag.log(POPDEN)  -0.01370891  0.01128957 -1.2143  0.224634

Lambda: 0.99424, LR test value: 1527.8, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.0024921
    z-value: 398.96, p-value: &lt; 2.22e-16
Wald statistic: 159170, p-value: &lt; 2.22e-16

Log likelihood: 1572.051 for error model
ML residual variance (sigma squared): 0.0019546, (sigma: 0.044211)
Number of observations: 983 
Number of parameters estimated: 17 
AIC: -3110.1, (AIC for lm: -1584.3)</code></pre>
</div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Impact measures of the Durbin model</span></span>
<span><span class="va">mod_1.durbe.imp</span> <span class="op">&lt;-</span> <span class="fu">impacts</span><span class="op">(</span><span class="va">mod_1.durbe</span>, listw <span class="op">=</span> <span class="va">dist_15.lw</span>, R <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.durbe.imp</span>, zstats <span class="op">=</span> <span class="cn">TRUE</span>, short <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (SDEM, glht, n):
                    Direct      Indirect         Total
per_mixed     0.0055333298  0.0010713981  0.0066047279
per_asian    -0.0001715584 -0.0006061567 -0.0007777151
per_black    -0.0005794704 -0.0019173261 -0.0024967965
per_other     0.0020339226  0.0101412504  0.0121751729
per_nonUK_EU  0.0008625423  0.0092561971  0.0101187394
per_nonEU     0.0013582217  0.0056356426  0.0069938643
log(POPDEN)   0.0271682392 -0.0137089088  0.0134593305
========================================================
Standard errors:
                   Direct     Indirect        Total
per_mixed    0.0022368774 0.0081932151 0.0089412446
per_asian    0.0002418282 0.0007008041 0.0007540247
per_black    0.0003442649 0.0013099673 0.0013639632
per_other    0.0011253352 0.0049697880 0.0051074709
per_nonUK_EU 0.0005890159 0.0021762395 0.0022231333
per_nonEU    0.0005348024 0.0018554128 0.0020196122
log(POPDEN)  0.0035423870 0.0112895670 0.0132006518
========================================================
Z-values:
                 Direct   Indirect     Total
per_mixed     2.4736849  0.1307665  0.738681
per_asian    -0.7094226 -0.8649446 -1.031419
per_black    -1.6832108 -1.4636442 -1.830545
per_other     1.8073926  2.0405801  2.383797
per_nonUK_EU  1.4643785  4.2532989  4.551567
per_nonEU     2.5396703  3.0374063  3.462974
log(POPDEN)   7.6694724 -1.2142989  1.019596

p-values:
             Direct     Indirect   Total     
per_mixed    0.013373   0.8959600  0.46010070
per_asian    0.478062   0.3870692  0.30234457
per_black    0.092334   0.1432912  0.06716843
per_other    0.070701   0.0412926  0.01713506
per_nonUK_EU 0.143091   2.1064e-05 5.3248e-06
per_nonEU    0.011096   0.0023862  0.00053424
log(POPDEN)  1.7319e-14 0.2246336  0.30792015</code></pre>
</div>
</div>
</section></section><section id="inkar-data-the-effect-of-regional-characteristics-on-life-expectancy" class="level2" data-number="11.2"><h2 data-number="11.2" class="anchored" data-anchor-id="inkar-data-the-effect-of-regional-characteristics-on-life-expectancy">
<span class="header-section-number">11.2</span> Inkar data: the effect of regional characteristics on life expectancy</h2>
<p>Below, we read and transform some characteristics of the <a href="https://www.inkar.de/">INKAR data</a> on German counties.</p>
<!-- ```{r} -->
<!-- di <- c("_data/") -->
<!-- # Define the downloaded filed -->
<!-- j <- c("inkar.csv") -->
<!-- c <- 1 -->
<!-- for(k in j){ -->

<!--   header <- as.vector(t(read.table(paste0(di, k), nrows = 1, sep = ";")[1,])) -->
<!--   # Clean header -->
<!--   header <- stringi::stri_replace_all_fixed( -->
<!--     header,  -->
<!--     c("Ã¤", "Ã¶", "Ã¼", "Ã„", "Ã–", "Ãœ"),  -->
<!--     c("ae", "oe", "ue", "Ae", "Oe", "Ue"),  -->
<!--     vectorize_all = FALSE -->
<!--   ) -->
<!--   header <- gsub(" ", "", header) -->
<!--   header <- gsub("\\.", "", header) -->
<!--   header <- iconv(header, "latin1", "ASCII", sub = "") -->
<!--   # Combine with second row header (year) -->

<!--   header2 <- as.vector(t(read.table(paste0(di, k), skip = 1, nrows = 1, sep = ";")[1,])) -->
<!--   header3 <- paste(header, header2, sep = "_") -->
<!--   header3 <- gsub("_NA", "", header3) -->
<!--   nc <- length(header3) -->
<!--   # Input and rename data -->
<!--   data <- read.csv(paste0(di, k), skip = 2, header = FALSE, sep = ";",  -->
<!--                    quote = "\"", dec = ",", stringsAsFactors = F, -->
<!--                    colClasses = "character") -->
<!--   names(data) <- header3 -->
<!--   data1 <- data -->
<!--   # Correct character vars (containing thousands separator) -->
<!--   vars <- which(sapply(data1, is.character)) -->
<!--   vars <- vars[-which(vars %in% c(1:3))] -->
<!--   for(l in vars){ -->
<!--     data1[,l] <- gsub("\\.", "", data1[,l]) -->
<!--     data1[,l] <- gsub("\\,", ".", data1[,l]) -->
<!--     data1[,l] <- as.numeric(data1[,l]) -->
<!--   } -->
<!--   # #Save -->
<!--   # l <- paste("bearb", k, sep = "_") -->

<!--   # write.table(data1, file = l, row.names = FALSE, sep = ";", dec = ".", na = ".") -->
<!--   # #Reshape -->
<!--   # helpvar1 <- unique(header[4:length(header)]) -->
<!--   # helpvar2 <-  sort(unique(header2[!is.na(header2)])) -->
<!--   # n_vars <- length(helpvar1) -->
<!--   # n_times <- length(helpvar2) -->
<!--   # helpvar1 <- sort(rep(helpvar1, times = n_times)) -->
<!--   # helpvar2 <- rep(helpvar2, times = n_vars) -->
<!--   # helpvar3 <- paste(helpvar1, helpvar2, sep = "_") -->
<!--   # count <- ncol(data1)+1 -->
<!--   # for(v in helpvar3) { -->
<!--   #   if(v %in% names(data1)) {} -->
<!--   #   else{ -->
<!--   #     data1[,count] <- NA -->
<!--   #     colnames(data1)[count] <- v -->
<!--   #     count <- count+1 -->
<!--   #   } -->
<!--   # } -->
<!--   # data1 <- data1[c(colnames(data1)[1:3], sort(helpvar3))] -->
<!--   #  -->
<!--   # data1 <- reshape(data1, direction = "long", varying = 4:ncol(data1),  -->
<!--   #                  sep = "_") -->
<!--   data.long <- tidyr::pivot_longer(data1,  -->
<!--                                   cols = 4:ncol(data1), -->
<!--                                   names_to = c(".value", "year"), -->
<!--                                   names_pattern = "(.*)_(.*)") -->
<!--   colnames(data.long) <- substr(colnames(data.long), 1, 30) -->
<!--   if(c == 1){ -->
<!--     inkar.df <- data.long -->
<!--   }else{ -->
<!--     inkar.df <- merge(inkar.df, data.long, all.x = TRUE, all.y = TRUE) -->
<!--   } -->
<!--   c <- c+1 -->
<!-- } -->
<!-- inkar.df$year <- as.numeric(inkar.df$year) -->
<!-- names(inkar.df)[which(names(inkar.df) == "Pkw-Dichte")] <- "pkw_dichte" -->
<!-- save(inkar.df, file = "_data/inkar.Rdata") -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"_data/inkar2.Rdata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Variables are</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>â€œKennzifferâ€</td>
<td>ID</td>
</tr>
<tr class="even">
<td>â€œRaumeinheitâ€</td>
<td>Name</td>
</tr>
<tr class="odd">
<td>â€œAggregatâ€</td>
<td>Level</td>
</tr>
<tr class="even">
<td>â€œyearâ€</td>
<td>Year</td>
</tr>
<tr class="odd">
<td>â€œpoluation_densityâ€</td>
<td>Population Density</td>
</tr>
<tr class="even">
<td>â€œmedian_incomeâ€</td>
<td>Median Household income (only for 2020)</td>
</tr>
<tr class="odd">
<td>â€œgdp_in1000EURâ€</td>
<td>Gross Domestic Product in 1000 euros</td>
</tr>
<tr class="even">
<td>â€œunemployment_rateâ€</td>
<td>Unemployment rate</td>
</tr>
<tr class="odd">
<td>â€œshare_longterm_unemployedâ€</td>
<td>Share of longterm unemployed (among unemployed)</td>
</tr>
<tr class="even">
<td>â€œshare_working_indutryâ€</td>
<td>Share of employees in undistrial sector</td>
</tr>
<tr class="odd">
<td>â€œshare_foreignersâ€</td>
<td>Share of foreign nationals</td>
</tr>
<tr class="even">
<td>â€œshare_collegeâ€</td>
<td>Share of school-finishers with college degree</td>
</tr>
<tr class="odd">
<td>â€œrecreational_spaceâ€</td>
<td>Recreational space per inhabitant</td>
</tr>
<tr class="even">
<td>â€œcar_densityâ€</td>
<td>Density of cars</td>
</tr>
<tr class="odd">
<td>â€œlife_expectancyâ€</td>
<td>Life expectancy</td>
</tr>
</tbody>
</table></section><section id="county-shapes" class="level2" data-number="11.3"><h2 data-number="11.3" class="anchored" data-anchor-id="county-shapes">
<span class="header-section-number">11.3</span> County shapes</h2>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kreise.spdf</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span>dsn <span class="op">=</span> <span class="st">"_data/vg5000_ebenen_1231"</span>,</span>
<span>                       layer <span class="op">=</span> <span class="st">"VG5000_KRS"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `VG5000_KRS' from data source 
  `C:\work\Lehre\Geodata_Spatial_Regression\_data\vg5000_ebenen_1231' 
  using driver `ESRI Shapefile'
Simple feature collection with 400 features and 24 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 280353.1 ymin: 5235878 xmax: 921261.6 ymax: 6101302
Projected CRS: ETRS89 / UTM zone 32N</code></pre>
</div>
</div>
<section id="please-map-the-life-expectancy-across-germany" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="please-map-the-life-expectancy-across-germany">1) Please map the life expectancy across Germany</h3>
<ol type="a">
<li>Merge data with the shape file (as with conventional data)</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Merge</span></span>
<span><span class="va">inkar_2020.spdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">kreise.spdf</span>, <span class="va">inkar.df</span><span class="op">[</span><span class="va">inkar.df</span><span class="op">$</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2020</span>, <span class="op">]</span>, </span>
<span>                         by.x <span class="op">=</span> <span class="st">"AGS"</span>, by.y <span class="op">=</span> <span class="st">"Kennziffer"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="a">
<li>Create a map of life-expectancy</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu">viridis</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, option <span class="op">=</span> <span class="st">"G"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mp1</span> <span class="op">&lt;-</span>  <span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">inkar_2020.spdf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">life_expectancy</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span></span>
<span>    colours <span class="op">=</span> <span class="va">cols</span>,  <span class="co"># your custom palette</span></span>
<span>    name <span class="op">=</span> <span class="st">"in years"</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"grey90"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Life expectancy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    legend.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mp1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08_exercise3_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section><section id="chose-some-variables-that-could-predict-life-expectancy.-see-for-instance-the-following-paper." class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="chose-some-variables-that-could-predict-life-expectancy.-see-for-instance-the-following-paper.">2) Chose some variables that could predict life expectancy. See for instance the <a href="https://doi.org/10.1073/pnas.2003719117">following paper</a>.</h3>
</section><section id="generate-a-neighbours-object-e.g.-the-10-nearest-neighbours." class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="generate-a-neighbours-object-e.g.-the-10-nearest-neighbours.">3) Generate a neighbours object (e.g.&nbsp;the 10 nearest neighbours).</h3>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># nb &lt;- poly2nb(kreise.spdf, row.names = "ags", queen = TRUE)</span></span>
<span><span class="va">knn</span> <span class="op">&lt;-</span> <span class="fu">knearneigh</span><span class="op">(</span><span class="fu">st_centroid</span><span class="op">(</span><span class="va">kreise.spdf</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over
geometries</code></pre>
</div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb</span> <span class="op">&lt;-</span> <span class="fu">knn2nb</span><span class="op">(</span><span class="va">knn</span>, row.names <span class="op">=</span> <span class="va">kreise.spdf</span><span class="op">$</span><span class="va">ags</span><span class="op">)</span></span>
<span><span class="va">listw</span> <span class="op">&lt;-</span> <span class="fu">nb2listw</span><span class="op">(</span><span class="va">nb</span>, style <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="estimate-a-cross-sectional-spatial-model-for-the-year-2020-and-calculate-the-impacts." class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="estimate-a-cross-sectional-spatial-model-for-the-year-2020-and-calculate-the-impacts.">4) Estimate a cross-sectional spatial model for the year 2020 and calculate the impacts.</h3>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Use a spatial Durbin Error model</span></span>
<span></span>
<span><span class="co"># Spec formula</span></span>
<span><span class="va">fm</span> <span class="op">&lt;-</span> <span class="va">life_expectancy</span> <span class="op">~</span> <span class="va">median_income</span> <span class="op">+</span> <span class="va">unemployment_rate</span> <span class="op">+</span> <span class="va">share_college</span> <span class="op">+</span> <span class="va">car_density</span></span>
<span></span>
<span><span class="co"># Estimate error model with Durbin = TRUE </span></span>
<span><span class="va">mod_1.durb</span> <span class="op">&lt;-</span> <span class="fu">errorsarlm</span><span class="op">(</span><span class="va">fm</span>,  </span>
<span>                      data <span class="op">=</span> <span class="va">inkar_2020.spdf</span>, </span>
<span>                      listw <span class="op">=</span> <span class="va">listw</span>,</span>
<span>                      Durbin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.durb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
errorsarlm(formula = fm, data = inkar_2020.spdf, listw = listw, 
    Durbin = TRUE)

Residuals:
      Min        1Q    Median        3Q       Max 
-1.343984 -0.349567  0.013307  0.333106  1.819014 

Type: error 
Coefficients: (asymptotic standard errors) 
                         Estimate  Std. Error  z value  Pr(&gt;|z|)
(Intercept)            8.4970e+01  1.4366e+00  59.1456 &lt; 2.2e-16
median_income          5.4013e-04  8.2285e-05   6.5641 5.233e-11
unemployment_rate     -3.8970e-01  2.0095e-02 -19.3923 &lt; 2.2e-16
share_college          6.7806e-03  3.2502e-03   2.0862  0.036956
car_density           -3.2042e-03  4.9774e-04  -6.4376 1.214e-10
lag.median_income      4.9282e-04  1.8112e-04   2.7209  0.006511
lag.unemployment_rate -3.4685e-02  4.5454e-02  -0.7631  0.445418
lag.share_college     -1.7065e-03  7.0324e-03  -0.2427  0.808270
lag.car_density       -5.2210e-03  1.7541e-03  -2.9765  0.002915

Lambda: 0.57895, LR test value: 48.146, p-value: 3.9563e-12
Asymptotic standard error: 0.069523
    z-value: 8.3275, p-value: &lt; 2.22e-16
Wald statistic: 69.347, p-value: &lt; 2.22e-16

Log likelihood: -305.6855 for error model
ML residual variance (sigma squared): 0.26001, (sigma: 0.50991)
Number of observations: 400 
Number of parameters estimated: 11 
AIC: 633.37, (AIC for lm: 679.52)</code></pre>
</div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate impacts (which is unnecessary in this case)</span></span>
<span><span class="va">mod_1.durb.imp</span> <span class="op">&lt;-</span> <span class="fu">impacts</span><span class="op">(</span><span class="va">mod_1.durb</span>, listw <span class="op">=</span> <span class="va">listw</span>, R <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_1.durb.imp</span>, zstats <span class="op">=</span> <span class="cn">TRUE</span>, short <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (SDEM, glht, n):
                         Direct      Indirect        Total
median_income      0.0005401284  0.0004928188  0.001032947
unemployment_rate -0.3896967422 -0.0346850810 -0.424381823
share_college      0.0067806262 -0.0017064694  0.005074157
car_density       -0.0032042374 -0.0052209850 -0.008425222
========================================================
Standard errors:
                        Direct     Indirect        Total
median_income     0.0000822846 0.0001811243 0.0001813217
unemployment_rate 0.0200953892 0.0454542641 0.0455757529
share_college     0.0032501555 0.0070323979 0.0069550103
car_density       0.0004977411 0.0017540570 0.0018942566
========================================================
Z-values:
                      Direct   Indirect      Total
median_income       6.564150  2.7208866  5.6967654
unemployment_rate -19.392346 -0.7630765 -9.3115702
share_college       2.086247 -0.2426583  0.7295686
car_density        -6.437558 -2.9765197 -4.4477726

p-values:
                  Direct     Indirect  Total     
median_income     5.2331e-11 0.0065107 1.2210e-08
unemployment_rate &lt; 2.22e-16 0.4454178 &lt; 2.22e-16
share_college     0.036956   0.8082701 0.46565   
car_density       1.2141e-10 0.0029154 8.6765e-06</code></pre>
</div>
</div>
</section><section id="calculate-the-spatial-lagged-variables-for-your-covariates-e.g.-use-create_wx-which-needs-a-non-spatial-df-as-input-." class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="calculate-the-spatial-lagged-variables-for-your-covariates-e.g.-use-create_wx-which-needs-a-non-spatial-df-as-input-.">5) Calculate the spatial lagged variables for your covariates (e.g.&nbsp;use create_WX(), which needs a non-spatial df as input) .</h3>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract covariate names</span></span>
<span><span class="va">covars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html">terms</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span>,<span class="st">"term.labels"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">w_vars</span> <span class="op">&lt;-</span> <span class="fu">create_WX</span><span class="op">(</span><span class="fu">st_drop_geometry</span><span class="op">(</span><span class="va">inkar_2020.spdf</span><span class="op">)</span><span class="op">[</span>, <span class="va">covars</span><span class="op">]</span>,</span>
<span>                    listw <span class="op">=</span> <span class="va">listw</span>,</span>
<span>                    prefix <span class="op">=</span> <span class="st">"w"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inkar_2020.spdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">inkar_2020.spdf</span>, <span class="va">w_vars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="can-you-run-a-spatial-machine-learning-model-for-instance-using-randomforest" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="can-you-run-a-spatial-machine-learning-model-for-instance-using-randomforest">6) Can you run a spatial machine learning model? (for instance, using <code>randomForest</code>)?</h3>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>randomForest 4.7-1.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Type rfNews() to see new features/changes/bug fixes.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'randomForest'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:ggplot2':

    margin</code></pre>
</div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Train</span></span>
<span><span class="va">rf.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html">randomForest</a></span><span class="op">(</span><span class="va">life_expectancy</span> <span class="op">~</span> <span class="va">median_income</span> <span class="op">+</span> <span class="va">unemployment_rate</span> <span class="op">+</span> <span class="va">share_college</span> <span class="op">+</span> <span class="va">car_density</span> <span class="op">+</span></span>
<span>                         <span class="va">w.median_income</span> <span class="op">+</span> <span class="va">w.unemployment_rate</span> <span class="op">+</span> <span class="va">w.share_college</span> <span class="op">+</span> <span class="va">w.car_density</span>,</span>
<span>                       data <span class="op">=</span> <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="va">inkar_2020.spdf</span><span class="op">)</span>, </span>
<span>                       ntree <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                       importance <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect the mechanics of the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/importance.html">importance</a></span><span class="op">(</span><span class="va">rf.mod</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     %IncMSE IncNodePurity
median_income       34.65260      41.44212
unemployment_rate   65.08032     117.70981
share_college       22.72131      26.87170
car_density         26.20873      33.38936
w.median_income     37.96073      56.76284
w.unemployment_rate 25.71133      51.65322
w.share_college     17.14812      24.28564
w.car_density       23.22659      29.85081</code></pre>
</div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/varImpPlot.html">varImpPlot</a></span><span class="op">(</span><span class="va">rf.mod</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="08_exercise3_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>You could even go further and use higher order neighbours (e.g.&nbsp;<code>nblag(queens.nb, maxlag = 3)</code>) to check the importance of direct neighbours and the neighbours neighbours and so on â€¦</p>
</section></section><section id="esimate-an-fe-model-with-slx-specification" class="level2" data-number="11.4"><h2 data-number="11.4" class="anchored" data-anchor-id="esimate-an-fe-model-with-slx-specification">
<span class="header-section-number">11.4</span> Esimate an FE model with SLX specification</h2>
<ol type="a">
<li>Loops over years to generate WX</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># We use gdp instead of median income (which is only available in recent year)</span></span>
<span><span class="va">fm</span> <span class="op">&lt;-</span> <span class="va">life_expectancy</span> <span class="op">~</span> <span class="va">gdp_in1000EUR</span> <span class="op">+</span> <span class="va">unemployment_rate</span> <span class="op">+</span> <span class="va">share_college</span> <span class="op">+</span> <span class="va">car_density</span></span>
<span></span>
<span><span class="co"># All years where we have a balanced sample</span></span>
<span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">inkar.df</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">inkar.df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># All variables we want ot lag</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create listw with the correct rownames (ID = Kennziffer)</span></span>
<span><span class="va">kreise.spdf</span><span class="op">$</span><span class="va">Kennziffer</span> <span class="op">&lt;-</span> <span class="va">kreise.spdf</span><span class="op">$</span><span class="va">ags</span></span>
<span><span class="va">knn</span> <span class="op">&lt;-</span> <span class="fu">knearneigh</span><span class="op">(</span><span class="fu">st_centroid</span><span class="op">(</span><span class="va">kreise.spdf</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">nb</span> <span class="op">&lt;-</span> <span class="fu">knn2nb</span><span class="op">(</span><span class="va">knn</span>, row.names <span class="op">=</span> <span class="va">kreise.spdf</span><span class="op">$</span><span class="va">Kennziffer</span><span class="op">)</span></span>
<span><span class="va">listw</span> <span class="op">&lt;-</span> <span class="fu">nb2listw</span><span class="op">(</span><span class="va">nb</span>, style <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="va">years</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Select singe year</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">inkar.df</span><span class="op">[</span><span class="va">inkar.df</span><span class="op">$</span><span class="va">year</span> <span class="op">==</span> <span class="va">y</span> ,<span class="op">]</span></span>
<span>  <span class="co"># Select variables and make df</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="va">tmp</span><span class="op">[</span>, <span class="va">vars</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co"># Add ID as rownames (we retreive them again later)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">Kennziffer</span></span>
<span>  <span class="co"># Perform lag transformation (rownames contian ids)</span></span>
<span>  <span class="va">w.tmp</span> <span class="op">&lt;-</span> <span class="fu">create_WX</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    listw <span class="op">=</span> <span class="va">listw</span>,</span>
<span>                    prefix <span class="op">=</span> <span class="st">"w"</span>,</span>
<span>                    zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># NAs will get zero</span></span>
<span>  <span class="va">w.tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">w.tmp</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add indices back</span></span>
<span>  <span class="va">w.tmp</span><span class="op">$</span><span class="va">Kennziffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">w.tmp</span><span class="op">)</span></span>
<span>  <span class="va">w.tmp</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">y</span> <span class="op">==</span> <span class="va">years</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">w.inkar.df</span> <span class="op">&lt;-</span> <span class="va">w.tmp</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">w.inkar.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">w.inkar.df</span>, <span class="va">w.tmp</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">w.inkar.df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      w.life_expectancy w.gdp_in1000EUR w.unemployment_rate
01001            77.386         3866035              10.257
01002            77.355         3812976              10.394
01003            77.237        10728945              11.666
01004            77.458         4586244               9.999
01051            77.291         4270208              10.007
01053            77.119        11012351              11.878
      w.share_college w.car_density Kennziffer year
01001          18.558       518.092      01001 1998
01002          20.389       516.400      01002 1998
01003          23.075       497.344      01003 1998
01004          20.798       516.580      01004 1998
01051          18.957       520.985      01051 1998
01053          23.625       501.522      01053 1998</code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Merge back </span></span>
<span></span>
<span><span class="va">inkar.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">inkar.df</span>, <span class="va">w.inkar.df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Kennziffer"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="a">
<li>Estimate a twoways FE SLX panel model</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">slx.fe</span> <span class="op">&lt;-</span> <span class="fu">felm</span><span class="op">(</span><span class="va">life_expectancy</span> <span class="op">~</span> <span class="va">gdp_in1000EUR</span> <span class="op">+</span> <span class="va">unemployment_rate</span> <span class="op">+</span> <span class="va">share_college</span> <span class="op">+</span> <span class="va">car_density</span> <span class="op">+</span></span>
<span>                 <span class="va">w.gdp_in1000EUR</span> <span class="op">+</span> <span class="va">w.unemployment_rate</span> <span class="op">+</span> <span class="va">w.share_college</span> <span class="op">+</span> <span class="va">w.car_density</span></span>
<span>                <span class="op">|</span> <span class="va">Kennziffer</span> <span class="op">+</span> <span class="va">year</span> <span class="op">|</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">Kennziffer</span>,</span>
<span>              data <span class="op">=</span> <span class="va">inkar.df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">slx.fe</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   felm(formula = life_expectancy ~ gdp_in1000EUR + unemployment_rate +      share_college + car_density + w.gdp_in1000EUR + w.unemployment_rate +      w.share_college + w.car_density | Kennziffer + year | 0 |      Kennziffer, data = inkar.df) 

Residuals:
     Min       1Q   Median       3Q      Max 
-1.62945 -0.17351  0.00156  0.17930  1.58230 

Coefficients:
                      Estimate Cluster s.e. t value Pr(&gt;|t|)   
gdp_in1000EUR        1.370e-08    4.323e-09   3.170  0.00164 **
unemployment_rate    4.875e-04    1.127e-02   0.043  0.96553   
share_college        2.565e-03    1.818e-03   1.411  0.15909   
car_density          4.277e-04    3.351e-04   1.276  0.20254   
w.gdp_in1000EUR      3.397e-08    1.107e-08   3.069  0.00230 **
w.unemployment_rate -2.848e-02    1.239e-02  -2.299  0.02203 * 
w.share_college     -4.753e-04    2.506e-03  -0.190  0.84966   
w.car_density        1.038e-03    8.283e-04   1.254  0.21072   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2957 on 8770 degrees of freedom
Multiple R-squared(full model): 0.9602   Adjusted R-squared: 0.9582 
Multiple R-squared(proj model): 0.02528   Adjusted R-squared: -0.0224 
F-statistic(full model, *iid*):492.7 on 429 and 8770 DF, p-value: &lt; 2.2e-16 
F-statistic(proj model): 4.508 on 8 and 399 DF, p-value: 2.929e-05 </code></pre>
</div>
</div>
<ol start="3" type="a">
<li>Estimate a twoways FE SAR panel model (use <code>spml()</code>)</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Estimate model</span></span>
<span><span class="va">sar.fe</span> <span class="op">&lt;-</span> <span class="fu">spml</span><span class="op">(</span><span class="va">life_expectancy</span> <span class="op">~</span> <span class="va">gdp_in1000EUR</span> <span class="op">+</span> <span class="va">unemployment_rate</span> <span class="op">+</span> <span class="va">share_college</span> <span class="op">+</span> <span class="va">car_density</span>, </span>
<span>               data <span class="op">=</span> <span class="va">inkar.df</span>, </span>
<span>               index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Kennziffer"</span>, <span class="st">"year"</span><span class="op">)</span>, </span>
<span>               listw <span class="op">=</span> <span class="va">listw</span>, </span>
<span>               model<span class="op">=</span> <span class="st">"within"</span>,</span>
<span>               effect<span class="op">=</span> <span class="st">"twoways"</span>,</span>
<span>               lag <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>               spatial.error <span class="op">=</span> <span class="st">"none"</span></span>
<span>               <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">sar.fe</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial panel fixed effects lag model
 

Call:
spml(formula = life_expectancy ~ gdp_in1000EUR + unemployment_rate + 
    share_college + car_density, data = inkar.df, index = c("Kennziffer", 
    "year"), listw = listw, model = "within", effect = "twoways", 
    lag = TRUE, spatial.error = "none")

Residuals:
       Min.     1st Qu.      Median     3rd Qu.        Max. 
-1.56935018 -0.16490692  0.00062493  0.16729792  1.38374052 

Spatial autoregressive coefficient:
       Estimate Std. Error t-value  Pr(&gt;|t|)    
lambda  0.47997    0.01653  29.037 &lt; 2.2e-16 ***

Coefficients:
                     Estimate  Std. Error t-value  Pr(&gt;|t|)    
gdp_in1000EUR      1.2031e-08  1.4786e-09  8.1369 4.056e-16 ***
unemployment_rate -1.0767e-02  2.0558e-03 -5.2375 1.627e-07 ***
share_college      1.8501e-03  7.0611e-04  2.6202  0.008788 ** 
car_density        3.4915e-04  1.1950e-04  2.9218  0.003480 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<ol start="4" type="a">
<li>Estimate the summary impacts.</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sar.fe.imp</span> <span class="op">&lt;-</span> <span class="fu">impacts</span><span class="op">(</span><span class="va">sar.fe</span>, listw <span class="op">=</span> <span class="va">listw</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span>, R <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">sar.fe.imp</span>, zstats <span class="op">=</span> <span class="cn">TRUE</span>, short <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Impact measures (lag, trace):
                         Direct      Indirect         Total
gdp_in1000EUR      1.236588e-08  1.076990e-08  2.313578e-08
unemployment_rate -1.106695e-02 -9.638614e-03 -2.070556e-02
share_college      1.901619e-03  1.656190e-03  3.557809e-03
car_density        3.588594e-04  3.125439e-04  6.714033e-04
========================================================
Simulation results ( variance matrix):
========================================================
Simulated standard errors
                        Direct     Indirect        Total
gdp_in1000EUR     1.542289e-09 1.541909e-09 3.011156e-09
unemployment_rate 2.200141e-03 2.036546e-03 4.189625e-03
share_college     7.115541e-04 6.228876e-04 1.329112e-03
car_density       1.227309e-04 1.106796e-04 2.323660e-04

Simulated z-values:
                     Direct  Indirect     Total
gdp_in1000EUR      7.953343  6.967766  7.641589
unemployment_rate -5.057592 -4.784963 -4.981882
share_college      2.701216  2.697955  2.710520
car_density        3.057534  2.968658  3.028945

Simulated p-values:
                  Direct     Indirect   Total     
gdp_in1000EUR     1.7764e-15 3.2201e-12 2.1538e-14
unemployment_rate 4.2458e-07 1.7102e-06 6.2969e-07
share_college     0.0069086  0.0069767  0.0067178 
car_density       0.0022317  0.0029910  0.0024541 </code></pre>
</div>
</div>
<!-- We use the `WDI` API package to retrieve data from the World Bank. -->
<!-- You can open the [World Bank Data browser](https://databank.worldbank.org/home.aspx) to go though the data. -->
<!-- You can search for indicators with `WDIsearch()`. -->
<!-- ```{r warning=FALSE} -->
<!-- library(WDI) -->
<!-- # Search GDP per capita -->
<!-- WDIsearch("CO2 intensity") -->
<!-- # Political Stability -->
<!-- WDIsearch("Political Stability") -->
<!-- #  -->
<!-- WDIsearch("democracy") -->
<!-- # The Democracy indicator is an additive eleven-point scale (0-10) -->
<!-- ``` -->
<!-- ```{r, cache=TRUE} -->
<!-- # Define countries, indicators to query, and time period -->
<!-- wd.df <- WDI(country = "all",  -->
<!--              indicator = c('population' = "SP.POP.TOTL",  -->
<!--                            'gdp_pc' = "NY.GDP.PCAP.KD",  -->
<!--                            'co2_pc' = "EN.ATM.CO2E.PC", -->
<!--                            'co2_intesity' = "EN.ATM.CO2E.EG.ZS", -->
<!--                            'gini' = "SI.POV.GINI", -->
<!--                            'political_stability' = "GV.POLI.ST.ES", -->
<!--                            'inst_democr' = "UPP.INS.DEMO.XQ"), -->
<!--              extra = TRUE, -->
<!--              start = 2010, end = 2019) -->
<!-- # Save -->
<!-- save(wd.df, file = "_data/WDI_data.RData") -->
<!-- ``` -->
<!-- ## Diffusion of political regimes -->
<!-- See for instance @Gleditsch.2006 for an example for the diffusion of democratization. -->


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./08_comparison.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Comparing and Selecting Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09_spatiotemporal.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatio-temporal models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb64" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>::: {.content-hidden unless-format="html"}</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>\newcommand{\tr}{\mathrm{tr}}</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>\newcommand{\rank}{\mathrm{rank}}</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>\newcommand{\plim}{\operatornamewithlimits{plim}}</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>\newcommand{\diag}{\mathrm{diag}}</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>\newcommand{\bm}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\boldsymbol{\mathbf{#1}}}</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>\newcommand{\Var}{\mathrm{Var}}</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>\newcommand{\Exp}{\mathrm{E}}</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>\newcommand{\Cov}{\mathrm{Cov}}</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>\newcommand\given<span class="co">[</span><span class="ot">1</span><span class="co">][]</span>{\:#1\vert\:}</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>\newcommand{\irow}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{%</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>\begin{pmatrix}#1\end{pmatrix}</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="fu"># Exercises III</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required packages {.unnumbered}</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, warning = FALSE, results = 'hide'}</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sf"</span>, <span class="st">"mapview"</span>, <span class="st">"spdep"</span>, <span class="st">"spatialreg"</span>, <span class="st">"ggplot2"</span>, <span class="st">"tmap"</span>, <span class="st">"viridis"</span>, <span class="st">"viridisLite"</span>, </span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>          <span class="st">"plm"</span>, <span class="st">"lfe"</span>, <span class="st">"splm"</span>, <span class="st">"SDPDmod"</span>)</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a><span class="fu">### Session info {.unnumbered}</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reload data from pervious session {.unnumbered}</span></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"_data/msoa2_spatial.RData"</span>)</span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## Environmental inequality (continued)</span></span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>Let's use the same neighbours weights definition as before:</span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(msoa.spdf)</span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Neighbours within 3km distance</span></span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a>dist_15.nb <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(coords, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="dv">2500</span>)</span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dist_15.nb)</span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a><span class="co"># There are some empty neighbour sets. Lets impute those with the nearest neighbour.</span></span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a>k2.nb <span class="ot">&lt;-</span> <span class="fu">knearneigh</span>(coords, <span class="at">k =</span> <span class="dv">1</span>)</span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace zero</span></span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a>nolink_ids <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">card</span>(dist_15.nb) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>dist_15.nb[<span class="fu">card</span>(dist_15.nb) <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> k2.nb<span class="sc">$</span>nn[nolink_ids, ]</span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dist_15.nb)</span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a><span class="co"># listw object with row-normalization</span></span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a>dist_15.lw <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(dist_15.nb, <span class="at">style =</span> <span class="st">"W"</span>)</span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>and estiamte the spatial SAR model: </span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true" tabindex="-1"></a>mod_1.sar <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">log</span>(no2) <span class="sc">~</span> per_mixed <span class="sc">+</span> per_asian <span class="sc">+</span> per_black <span class="sc">+</span> per_other</span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">+</span> per_nonUK_EU <span class="sc">+</span> per_nonEU  <span class="sc">+</span> <span class="fu">log</span>(POPDEN),  </span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> msoa.spdf, </span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true" tabindex="-1"></a>                      <span class="at">listw =</span> dist_15.lw,</span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Durbin =</span> <span class="cn">FALSE</span>) <span class="co"># we could here extend to SDM</span></span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.sar)</span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1) Please calculate the true multiplier matrix of this SAR model. {.unnumbered}</span></span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true" tabindex="-1"></a>The multiplier matrix is given by $({\bm I_N}-\rho {\bm W})^{-1}$.</span>
<span id="cb64-93"><a href="#cb64-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-96"><a href="#cb64-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-97"><a href="#cb64-97" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">listw2mat</span>(dist_15.lw)</span>
<span id="cb64-98"><a href="#cb64-98" aria-hidden="true" tabindex="-1"></a>I <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">dim</span>(W)[<span class="dv">1</span>])</span>
<span id="cb64-99"><a href="#cb64-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-100"><a href="#cb64-100" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fu">unname</span>(mod_1.sar<span class="sc">$</span>rho)</span>
<span id="cb64-101"><a href="#cb64-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-102"><a href="#cb64-102" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">solve</span>(I <span class="sc">-</span> rho<span class="sc">*</span>W)</span>
<span id="cb64-103"><a href="#cb64-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-104"><a href="#cb64-104" aria-hidden="true" tabindex="-1"></a>M[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb64-105"><a href="#cb64-105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-106"><a href="#cb64-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-107"><a href="#cb64-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-108"><a href="#cb64-108" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2) Create an N x N effects matrix for the effect of the non-EU citizens. What is the effect of unit 6 on unit 10? Why is this larger than the effect of unit 5 on unit 8? {.unnumbered}</span></span>
<span id="cb64-109"><a href="#cb64-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-110"><a href="#cb64-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-113"><a href="#cb64-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-114"><a href="#cb64-114" aria-hidden="true" tabindex="-1"></a><span class="co"># For beta 1</span></span>
<span id="cb64-115"><a href="#cb64-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-116"><a href="#cb64-116" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> mod_1.sar<span class="sc">$</span>coefficients</span>
<span id="cb64-117"><a href="#cb64-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-118"><a href="#cb64-118" aria-hidden="true" tabindex="-1"></a>effM <span class="ot">&lt;-</span> beta[<span class="st">"per_nonEU"</span>] <span class="sc">*</span> M</span>
<span id="cb64-119"><a href="#cb64-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-120"><a href="#cb64-120" aria-hidden="true" tabindex="-1"></a>effM[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb64-121"><a href="#cb64-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-122"><a href="#cb64-122" aria-hidden="true" tabindex="-1"></a><span class="co"># "Effect" of unit 6 on unit 10</span></span>
<span id="cb64-123"><a href="#cb64-123" aria-hidden="true" tabindex="-1"></a>effM[<span class="dv">10</span>, <span class="dv">6</span>]</span>
<span id="cb64-124"><a href="#cb64-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-125"><a href="#cb64-125" aria-hidden="true" tabindex="-1"></a><span class="co"># "Effect" of unit 5 on unit 8</span></span>
<span id="cb64-126"><a href="#cb64-126" aria-hidden="true" tabindex="-1"></a>effM[<span class="dv">8</span>, <span class="dv">5</span>]</span>
<span id="cb64-127"><a href="#cb64-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-128"><a href="#cb64-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-129"><a href="#cb64-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-130"><a href="#cb64-130" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3) Calculate and interpret the summary impact measures of the SAR model. {.unnumbered}</span></span>
<span id="cb64-131"><a href="#cb64-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-132"><a href="#cb64-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-135"><a href="#cb64-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-136"><a href="#cb64-136" aria-hidden="true" tabindex="-1"></a>mod_1.sar.imp <span class="ot">&lt;-</span> <span class="fu">impacts</span>(mod_1.sar, <span class="at">listw =</span> dist_15.lw, <span class="at">R =</span> <span class="dv">300</span>)</span>
<span id="cb64-137"><a href="#cb64-137" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.sar.imp)</span>
<span id="cb64-138"><a href="#cb64-138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-139"><a href="#cb64-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-140"><a href="#cb64-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-141"><a href="#cb64-141" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4) Is SAR the right model choice or would you rather estimate a different model? Please run a Durbin model and caculate its impact summary measures {.unnumbered}</span></span>
<span id="cb64-142"><a href="#cb64-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-143"><a href="#cb64-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-146"><a href="#cb64-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-147"><a href="#cb64-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Dubrbin model</span></span>
<span id="cb64-148"><a href="#cb64-148" aria-hidden="true" tabindex="-1"></a>mod_1.durb <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">log</span>(no2) <span class="sc">~</span> per_mixed <span class="sc">+</span> per_asian <span class="sc">+</span> per_black <span class="sc">+</span> per_other</span>
<span id="cb64-149"><a href="#cb64-149" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">+</span> per_nonUK_EU <span class="sc">+</span> per_nonEU <span class="sc">+</span> <span class="fu">log</span>(POPDEN),  </span>
<span id="cb64-150"><a href="#cb64-150" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> msoa.spdf, </span>
<span id="cb64-151"><a href="#cb64-151" aria-hidden="true" tabindex="-1"></a>                      <span class="at">listw =</span> dist_15.lw,</span>
<span id="cb64-152"><a href="#cb64-152" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Durbin =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-153"><a href="#cb64-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-154"><a href="#cb64-154" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.durb)</span>
<span id="cb64-155"><a href="#cb64-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-156"><a href="#cb64-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Impact measures of the Durbin Error model</span></span>
<span id="cb64-157"><a href="#cb64-157" aria-hidden="true" tabindex="-1"></a>mod_1.durb.imp <span class="ot">&lt;-</span> <span class="fu">impacts</span>(mod_1.durb, <span class="at">listw =</span> dist_15.lw, <span class="at">R =</span> <span class="dv">300</span>)</span>
<span id="cb64-158"><a href="#cb64-158" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.durb.imp, <span class="at">zstats =</span> <span class="cn">TRUE</span>, <span class="at">short =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-159"><a href="#cb64-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-160"><a href="#cb64-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-161"><a href="#cb64-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-162"><a href="#cb64-162" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5) Please repeat with a Durbin Error model. Why are the impacts here idenptical to the coefficients? {.unnumbered}</span></span>
<span id="cb64-163"><a href="#cb64-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-166"><a href="#cb64-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-167"><a href="#cb64-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Dubrbin model</span></span>
<span id="cb64-168"><a href="#cb64-168" aria-hidden="true" tabindex="-1"></a>mod_1.durbe <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(<span class="fu">log</span>(no2) <span class="sc">~</span> per_mixed <span class="sc">+</span> per_asian <span class="sc">+</span> per_black <span class="sc">+</span> per_other</span>
<span id="cb64-169"><a href="#cb64-169" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">+</span> per_nonUK_EU <span class="sc">+</span> per_nonEU <span class="sc">+</span> <span class="fu">log</span>(POPDEN),  </span>
<span id="cb64-170"><a href="#cb64-170" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> msoa.spdf, </span>
<span id="cb64-171"><a href="#cb64-171" aria-hidden="true" tabindex="-1"></a>                      <span class="at">listw =</span> dist_15.lw,</span>
<span id="cb64-172"><a href="#cb64-172" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Durbin =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-173"><a href="#cb64-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-174"><a href="#cb64-174" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.durbe)</span>
<span id="cb64-175"><a href="#cb64-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-176"><a href="#cb64-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Impact measures of the Durbin model</span></span>
<span id="cb64-177"><a href="#cb64-177" aria-hidden="true" tabindex="-1"></a>mod_1.durbe.imp <span class="ot">&lt;-</span> <span class="fu">impacts</span>(mod_1.durbe, <span class="at">listw =</span> dist_15.lw, <span class="at">R =</span> <span class="dv">300</span>)</span>
<span id="cb64-178"><a href="#cb64-178" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.durbe.imp, <span class="at">zstats =</span> <span class="cn">TRUE</span>, <span class="at">short =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-179"><a href="#cb64-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-180"><a href="#cb64-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-181"><a href="#cb64-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-182"><a href="#cb64-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-183"><a href="#cb64-183" aria-hidden="true" tabindex="-1"></a><span class="fu">## Inkar data: the effect of regional characteristics on life expectancy</span></span>
<span id="cb64-184"><a href="#cb64-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-185"><a href="#cb64-185" aria-hidden="true" tabindex="-1"></a>Below, we read and transform some characteristics of the <span class="co">[</span><span class="ot">INKAR data</span><span class="co">](https://www.inkar.de/)</span> on German counties.</span>
<span id="cb64-186"><a href="#cb64-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-187"><a href="#cb64-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-188"><a href="#cb64-188" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb64-189"><a href="#cb64-189" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- di &lt;- c("_data/") --&gt;</span></span>
<span id="cb64-190"><a href="#cb64-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-191"><a href="#cb64-191" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Define the downloaded filed --&gt;</span></span>
<span id="cb64-192"><a href="#cb64-192" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- j &lt;- c("inkar.csv") --&gt;</span></span>
<span id="cb64-193"><a href="#cb64-193" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- c &lt;- 1 --&gt;</span></span>
<span id="cb64-194"><a href="#cb64-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-195"><a href="#cb64-195" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- for(k in j){ --&gt;</span></span>
<span id="cb64-196"><a href="#cb64-196" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header &lt;- as.vector(t(read.table(paste0(di, k), nrows = 1, sep = ";")[1,])) --&gt;</span></span>
<span id="cb64-197"><a href="#cb64-197" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Clean header --&gt;</span></span>
<span id="cb64-198"><a href="#cb64-198" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header &lt;- stringi::stri_replace_all_fixed( --&gt;</span></span>
<span id="cb64-199"><a href="#cb64-199" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     header,  --&gt;</span></span>
<span id="cb64-200"><a href="#cb64-200" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     c("Ã¤", "Ã¶", "Ã¼", "Ã„", "Ã–", "Ãœ"),  --&gt;</span></span>
<span id="cb64-201"><a href="#cb64-201" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     c("ae", "oe", "ue", "Ae", "Oe", "Ue"),  --&gt;</span></span>
<span id="cb64-202"><a href="#cb64-202" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     vectorize_all = FALSE --&gt;</span></span>
<span id="cb64-203"><a href="#cb64-203" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb64-204"><a href="#cb64-204" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header &lt;- gsub(" ", "", header) --&gt;</span></span>
<span id="cb64-205"><a href="#cb64-205" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header &lt;- gsub("\\.", "", header) --&gt;</span></span>
<span id="cb64-206"><a href="#cb64-206" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header &lt;- iconv(header, "latin1", "ASCII", sub = "") --&gt;</span></span>
<span id="cb64-207"><a href="#cb64-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-208"><a href="#cb64-208" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Combine with second row header (year) --&gt;</span></span>
<span id="cb64-209"><a href="#cb64-209" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header2 &lt;- as.vector(t(read.table(paste0(di, k), skip = 1, nrows = 1, sep = ";")[1,])) --&gt;</span></span>
<span id="cb64-210"><a href="#cb64-210" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header3 &lt;- paste(header, header2, sep = "_") --&gt;</span></span>
<span id="cb64-211"><a href="#cb64-211" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   header3 &lt;- gsub("_NA", "", header3) --&gt;</span></span>
<span id="cb64-212"><a href="#cb64-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-213"><a href="#cb64-213" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   nc &lt;- length(header3) --&gt;</span></span>
<span id="cb64-214"><a href="#cb64-214" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Input and rename data --&gt;</span></span>
<span id="cb64-215"><a href="#cb64-215" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data &lt;- read.csv(paste0(di, k), skip = 2, header = FALSE, sep = ";",  --&gt;</span></span>
<span id="cb64-216"><a href="#cb64-216" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                    quote = "\"", dec = ",", stringsAsFactors = F, --&gt;</span></span>
<span id="cb64-217"><a href="#cb64-217" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                    colClasses = "character") --&gt;</span></span>
<span id="cb64-218"><a href="#cb64-218" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   names(data) &lt;- header3 --&gt;</span></span>
<span id="cb64-219"><a href="#cb64-219" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data1 &lt;- data --&gt;</span></span>
<span id="cb64-220"><a href="#cb64-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-221"><a href="#cb64-221" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Correct character vars (containing thousands separator) --&gt;</span></span>
<span id="cb64-222"><a href="#cb64-222" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   vars &lt;- which(sapply(data1, is.character)) --&gt;</span></span>
<span id="cb64-223"><a href="#cb64-223" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   vars &lt;- vars[-which(vars %in% c(1:3))] --&gt;</span></span>
<span id="cb64-224"><a href="#cb64-224" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   for(l in vars){ --&gt;</span></span>
<span id="cb64-225"><a href="#cb64-225" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data1[,l] &lt;- gsub("\\.", "", data1[,l]) --&gt;</span></span>
<span id="cb64-226"><a href="#cb64-226" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data1[,l] &lt;- gsub("\\,", ".", data1[,l]) --&gt;</span></span>
<span id="cb64-227"><a href="#cb64-227" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data1[,l] &lt;- as.numeric(data1[,l]) --&gt;</span></span>
<span id="cb64-228"><a href="#cb64-228" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   } --&gt;</span></span>
<span id="cb64-229"><a href="#cb64-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-230"><a href="#cb64-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-231"><a href="#cb64-231" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # #Save --&gt;</span></span>
<span id="cb64-232"><a href="#cb64-232" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # l &lt;- paste("bearb", k, sep = "_") --&gt;</span></span>
<span id="cb64-233"><a href="#cb64-233" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # write.table(data1, file = l, row.names = FALSE, sep = ";", dec = ".", na = ".") --&gt;</span></span>
<span id="cb64-234"><a href="#cb64-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-235"><a href="#cb64-235" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # #Reshape --&gt;</span></span>
<span id="cb64-236"><a href="#cb64-236" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # helpvar1 &lt;- unique(header[4:length(header)]) --&gt;</span></span>
<span id="cb64-237"><a href="#cb64-237" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # helpvar2 &lt;-  sort(unique(header2[!is.na(header2)])) --&gt;</span></span>
<span id="cb64-238"><a href="#cb64-238" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # n_vars &lt;- length(helpvar1) --&gt;</span></span>
<span id="cb64-239"><a href="#cb64-239" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # n_times &lt;- length(helpvar2) --&gt;</span></span>
<span id="cb64-240"><a href="#cb64-240" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # helpvar1 &lt;- sort(rep(helpvar1, times = n_times)) --&gt;</span></span>
<span id="cb64-241"><a href="#cb64-241" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # helpvar2 &lt;- rep(helpvar2, times = n_vars) --&gt;</span></span>
<span id="cb64-242"><a href="#cb64-242" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # helpvar3 &lt;- paste(helpvar1, helpvar2, sep = "_") --&gt;</span></span>
<span id="cb64-243"><a href="#cb64-243" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # count &lt;- ncol(data1)+1 --&gt;</span></span>
<span id="cb64-244"><a href="#cb64-244" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # for(v in helpvar3) { --&gt;</span></span>
<span id="cb64-245"><a href="#cb64-245" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #   if(v %in% names(data1)) {} --&gt;</span></span>
<span id="cb64-246"><a href="#cb64-246" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #   else{ --&gt;</span></span>
<span id="cb64-247"><a href="#cb64-247" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #     data1[,count] &lt;- NA --&gt;</span></span>
<span id="cb64-248"><a href="#cb64-248" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #     colnames(data1)[count] &lt;- v --&gt;</span></span>
<span id="cb64-249"><a href="#cb64-249" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #     count &lt;- count+1 --&gt;</span></span>
<span id="cb64-250"><a href="#cb64-250" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #   } --&gt;</span></span>
<span id="cb64-251"><a href="#cb64-251" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # } --&gt;</span></span>
<span id="cb64-252"><a href="#cb64-252" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # data1 &lt;- data1[c(colnames(data1)[1:3], sort(helpvar3))] --&gt;</span></span>
<span id="cb64-253"><a href="#cb64-253" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #  --&gt;</span></span>
<span id="cb64-254"><a href="#cb64-254" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # data1 &lt;- reshape(data1, direction = "long", varying = 4:ncol(data1),  --&gt;</span></span>
<span id="cb64-255"><a href="#cb64-255" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #                  sep = "_") --&gt;</span></span>
<span id="cb64-256"><a href="#cb64-256" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data.long &lt;- tidyr::pivot_longer(data1,  --&gt;</span></span>
<span id="cb64-257"><a href="#cb64-257" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                   cols = 4:ncol(data1), --&gt;</span></span>
<span id="cb64-258"><a href="#cb64-258" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                   names_to = c(".value", "year"), --&gt;</span></span>
<span id="cb64-259"><a href="#cb64-259" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                   names_pattern = "(.*)_(.*)") --&gt;</span></span>
<span id="cb64-260"><a href="#cb64-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-261"><a href="#cb64-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-262"><a href="#cb64-262" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   colnames(data.long) &lt;- substr(colnames(data.long), 1, 30) --&gt;</span></span>
<span id="cb64-263"><a href="#cb64-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-264"><a href="#cb64-264" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   if(c == 1){ --&gt;</span></span>
<span id="cb64-265"><a href="#cb64-265" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     inkar.df &lt;- data.long --&gt;</span></span>
<span id="cb64-266"><a href="#cb64-266" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   }else{ --&gt;</span></span>
<span id="cb64-267"><a href="#cb64-267" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     inkar.df &lt;- merge(inkar.df, data.long, all.x = TRUE, all.y = TRUE) --&gt;</span></span>
<span id="cb64-268"><a href="#cb64-268" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   } --&gt;</span></span>
<span id="cb64-269"><a href="#cb64-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-270"><a href="#cb64-270" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   c &lt;- c+1 --&gt;</span></span>
<span id="cb64-271"><a href="#cb64-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-272"><a href="#cb64-272" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb64-273"><a href="#cb64-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-274"><a href="#cb64-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-275"><a href="#cb64-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-276"><a href="#cb64-276" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- inkar.df$year &lt;- as.numeric(inkar.df$year) --&gt;</span></span>
<span id="cb64-277"><a href="#cb64-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-278"><a href="#cb64-278" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- names(inkar.df)[which(names(inkar.df) == "Pkw-Dichte")] &lt;- "pkw_dichte" --&gt;</span></span>
<span id="cb64-279"><a href="#cb64-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-280"><a href="#cb64-280" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- save(inkar.df, file = "_data/inkar.Rdata") --&gt;</span></span>
<span id="cb64-281"><a href="#cb64-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-282"><a href="#cb64-282" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb64-283"><a href="#cb64-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-286"><a href="#cb64-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-287"><a href="#cb64-287" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"_data/inkar2.Rdata"</span>)</span>
<span id="cb64-288"><a href="#cb64-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-289"><a href="#cb64-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-290"><a href="#cb64-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-291"><a href="#cb64-291" aria-hidden="true" tabindex="-1"></a>Variables are</span>
<span id="cb64-292"><a href="#cb64-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-293"><a href="#cb64-293" aria-hidden="true" tabindex="-1"></a>| Variable | Description |</span>
<span id="cb64-294"><a href="#cb64-294" aria-hidden="true" tabindex="-1"></a>| ------------                     | ------------ |</span>
<span id="cb64-295"><a href="#cb64-295" aria-hidden="true" tabindex="-1"></a>| "Kennziffer"                      | ID                                         |</span>
<span id="cb64-296"><a href="#cb64-296" aria-hidden="true" tabindex="-1"></a>| "Raumeinheit"                     | Name                                       |</span>
<span id="cb64-297"><a href="#cb64-297" aria-hidden="true" tabindex="-1"></a>| "Aggregat"                        | Level                                      |</span>
<span id="cb64-298"><a href="#cb64-298" aria-hidden="true" tabindex="-1"></a>| "year"                            | Year                                       |</span>
<span id="cb64-299"><a href="#cb64-299" aria-hidden="true" tabindex="-1"></a>| "poluation_density"               | Population Density       |</span>
<span id="cb64-300"><a href="#cb64-300" aria-hidden="true" tabindex="-1"></a>| "median_income"                   | Median Household income (only for 2020)                   |</span>
<span id="cb64-301"><a href="#cb64-301" aria-hidden="true" tabindex="-1"></a>| "gdp_in1000EUR"                   | Gross Domestic Product in 1000 euros                            |</span>
<span id="cb64-302"><a href="#cb64-302" aria-hidden="true" tabindex="-1"></a>| "unemployment_rate"               | Unemployment rate                            |</span>
<span id="cb64-303"><a href="#cb64-303" aria-hidden="true" tabindex="-1"></a>| "share_longterm_unemployed"       | Share of longterm unemployed (among unemployed)                               |</span>
<span id="cb64-304"><a href="#cb64-304" aria-hidden="true" tabindex="-1"></a>| "share_working_indutry"           | Share of employees in undistrial sector                    |</span>
<span id="cb64-305"><a href="#cb64-305" aria-hidden="true" tabindex="-1"></a>| "share_foreigners"                | Share of foreign nationals                              |</span>
<span id="cb64-306"><a href="#cb64-306" aria-hidden="true" tabindex="-1"></a>| "share_college"                   | Share of school-finishers with college degree                              |</span>
<span id="cb64-307"><a href="#cb64-307" aria-hidden="true" tabindex="-1"></a>| "recreational_space"              | Recreational space per inhabitant                           |</span>
<span id="cb64-308"><a href="#cb64-308" aria-hidden="true" tabindex="-1"></a>| "car_density"                     | Density of cars                                 |</span>
<span id="cb64-309"><a href="#cb64-309" aria-hidden="true" tabindex="-1"></a>| "life_expectancy"                 | Life expectancy       |</span>
<span id="cb64-310"><a href="#cb64-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-311"><a href="#cb64-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-312"><a href="#cb64-312" aria-hidden="true" tabindex="-1"></a><span class="fu">## County shapes</span></span>
<span id="cb64-313"><a href="#cb64-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-316"><a href="#cb64-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-317"><a href="#cb64-317" aria-hidden="true" tabindex="-1"></a>kreise.spdf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"_data/vg5000_ebenen_1231"</span>,</span>
<span id="cb64-318"><a href="#cb64-318" aria-hidden="true" tabindex="-1"></a>                       <span class="at">layer =</span> <span class="st">"VG5000_KRS"</span>)</span>
<span id="cb64-319"><a href="#cb64-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-320"><a href="#cb64-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-321"><a href="#cb64-321" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1) Please map the life expectancy across Germany {.unnumbered}</span></span>
<span id="cb64-322"><a href="#cb64-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-323"><a href="#cb64-323" aria-hidden="true" tabindex="-1"></a>a) Merge data with the shape file (as with conventional data)</span>
<span id="cb64-324"><a href="#cb64-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-327"><a href="#cb64-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-328"><a href="#cb64-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge</span></span>
<span id="cb64-329"><a href="#cb64-329" aria-hidden="true" tabindex="-1"></a>inkar_2020.spdf <span class="ot">&lt;-</span> <span class="fu">merge</span>(kreise.spdf, inkar.df[inkar.df<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2020</span>, ], </span>
<span id="cb64-330"><a href="#cb64-330" aria-hidden="true" tabindex="-1"></a>                         <span class="at">by.x =</span> <span class="st">"AGS"</span>, <span class="at">by.y =</span> <span class="st">"Kennziffer"</span>)</span>
<span id="cb64-331"><a href="#cb64-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-332"><a href="#cb64-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-333"><a href="#cb64-333" aria-hidden="true" tabindex="-1"></a>b) Create a map of life-expectancy</span>
<span id="cb64-334"><a href="#cb64-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-337"><a href="#cb64-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-338"><a href="#cb64-338" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">viridis</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">option =</span> <span class="st">"G"</span>)</span>
<span id="cb64-339"><a href="#cb64-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-340"><a href="#cb64-340" aria-hidden="true" tabindex="-1"></a>mp1 <span class="ot">&lt;-</span>  <span class="fu">ggplot</span>(<span class="at">data =</span> inkar_2020.spdf) <span class="sc">+</span></span>
<span id="cb64-341"><a href="#cb64-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> life_expectancy), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb64-342"><a href="#cb64-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(</span>
<span id="cb64-343"><a href="#cb64-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> cols,  <span class="co"># your custom palette</span></span>
<span id="cb64-344"><a href="#cb64-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"in years"</span>,</span>
<span id="cb64-345"><a href="#cb64-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"grey90"</span></span>
<span id="cb64-346"><a href="#cb64-346" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-347"><a href="#cb64-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Life expectancy"</span>) <span class="sc">+</span></span>
<span id="cb64-348"><a href="#cb64-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb64-349"><a href="#cb64-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb64-350"><a href="#cb64-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb64-351"><a href="#cb64-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb64-352"><a href="#cb64-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb64-353"><a href="#cb64-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb64-354"><a href="#cb64-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-355"><a href="#cb64-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-356"><a href="#cb64-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb64-357"><a href="#cb64-357" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb64-358"><a href="#cb64-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-359"><a href="#cb64-359" aria-hidden="true" tabindex="-1"></a>mp1</span>
<span id="cb64-360"><a href="#cb64-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-361"><a href="#cb64-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-362"><a href="#cb64-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-363"><a href="#cb64-363" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2) Chose some variables that could predict life expectancy. See for instance the [following paper](https://doi.org/10.1073/pnas.2003719117). {.unnumbered}</span></span>
<span id="cb64-364"><a href="#cb64-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-365"><a href="#cb64-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-366"><a href="#cb64-366" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3) Generate a neighbours object (e.g. the 10 nearest neighbours). {.unnumbered}</span></span>
<span id="cb64-367"><a href="#cb64-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-370"><a href="#cb64-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-371"><a href="#cb64-371" aria-hidden="true" tabindex="-1"></a><span class="co"># nb &lt;- poly2nb(kreise.spdf, row.names = "ags", queen = TRUE)</span></span>
<span id="cb64-372"><a href="#cb64-372" aria-hidden="true" tabindex="-1"></a>knn <span class="ot">&lt;-</span> <span class="fu">knearneigh</span>(<span class="fu">st_centroid</span>(kreise.spdf), <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb64-373"><a href="#cb64-373" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(knn, <span class="at">row.names =</span> kreise.spdf<span class="sc">$</span>ags)</span>
<span id="cb64-374"><a href="#cb64-374" aria-hidden="true" tabindex="-1"></a>listw <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(nb, <span class="at">style =</span> <span class="st">"W"</span>)</span>
<span id="cb64-375"><a href="#cb64-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-376"><a href="#cb64-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-377"><a href="#cb64-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-378"><a href="#cb64-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4) Estimate a cross-sectional spatial model for the year 2020 and calculate the impacts. {.unnumbered}</span></span>
<span id="cb64-379"><a href="#cb64-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-380"><a href="#cb64-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-383"><a href="#cb64-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-384"><a href="#cb64-384" aria-hidden="true" tabindex="-1"></a><span class="do">### Use a spatial Durbin Error model</span></span>
<span id="cb64-385"><a href="#cb64-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-386"><a href="#cb64-386" aria-hidden="true" tabindex="-1"></a><span class="co"># Spec formula</span></span>
<span id="cb64-387"><a href="#cb64-387" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> life_expectancy <span class="sc">~</span> median_income <span class="sc">+</span> unemployment_rate <span class="sc">+</span> share_college <span class="sc">+</span> car_density</span>
<span id="cb64-388"><a href="#cb64-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-389"><a href="#cb64-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate error model with Durbin = TRUE </span></span>
<span id="cb64-390"><a href="#cb64-390" aria-hidden="true" tabindex="-1"></a>mod_1.durb <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(fm,  </span>
<span id="cb64-391"><a href="#cb64-391" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> inkar_2020.spdf, </span>
<span id="cb64-392"><a href="#cb64-392" aria-hidden="true" tabindex="-1"></a>                      <span class="at">listw =</span> listw,</span>
<span id="cb64-393"><a href="#cb64-393" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Durbin =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-394"><a href="#cb64-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-395"><a href="#cb64-395" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.durb)</span>
<span id="cb64-396"><a href="#cb64-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-397"><a href="#cb64-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate impacts (which is unnecessary in this case)</span></span>
<span id="cb64-398"><a href="#cb64-398" aria-hidden="true" tabindex="-1"></a>mod_1.durb.imp <span class="ot">&lt;-</span> <span class="fu">impacts</span>(mod_1.durb, <span class="at">listw =</span> listw, <span class="at">R =</span> <span class="dv">300</span>)</span>
<span id="cb64-399"><a href="#cb64-399" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1.durb.imp, <span class="at">zstats =</span> <span class="cn">TRUE</span>, <span class="at">short =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-400"><a href="#cb64-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-401"><a href="#cb64-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-402"><a href="#cb64-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-403"><a href="#cb64-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-404"><a href="#cb64-404" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5) Calculate the spatial lagged variables for your covariates (e.g. use create_WX(), which needs a non-spatial df as input) . {.unnumbered}</span></span>
<span id="cb64-405"><a href="#cb64-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-406"><a href="#cb64-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-409"><a href="#cb64-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-410"><a href="#cb64-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract covariate names</span></span>
<span id="cb64-411"><a href="#cb64-411" aria-hidden="true" tabindex="-1"></a>covars <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">terms</span>(fm),<span class="st">"term.labels"</span>)</span>
<span id="cb64-412"><a href="#cb64-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-413"><a href="#cb64-413" aria-hidden="true" tabindex="-1"></a>w_vars <span class="ot">&lt;-</span> <span class="fu">create_WX</span>(<span class="fu">st_drop_geometry</span>(inkar_2020.spdf)[, covars],</span>
<span id="cb64-414"><a href="#cb64-414" aria-hidden="true" tabindex="-1"></a>                    <span class="at">listw =</span> listw,</span>
<span id="cb64-415"><a href="#cb64-415" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prefix =</span> <span class="st">"w"</span>)</span>
<span id="cb64-416"><a href="#cb64-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-417"><a href="#cb64-417" aria-hidden="true" tabindex="-1"></a>inkar_2020.spdf <span class="ot">&lt;-</span> <span class="fu">cbind</span>(inkar_2020.spdf, w_vars)</span>
<span id="cb64-418"><a href="#cb64-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-419"><a href="#cb64-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-420"><a href="#cb64-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-421"><a href="#cb64-421" aria-hidden="true" tabindex="-1"></a><span class="fu">### 6) Can you run a spatial machine learning model? (for instance, using `randomForest`)? {.unnumbered}</span></span>
<span id="cb64-422"><a href="#cb64-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-425"><a href="#cb64-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-426"><a href="#cb64-426" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb64-427"><a href="#cb64-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-428"><a href="#cb64-428" aria-hidden="true" tabindex="-1"></a><span class="co"># Train</span></span>
<span id="cb64-429"><a href="#cb64-429" aria-hidden="true" tabindex="-1"></a>rf.mod <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(life_expectancy <span class="sc">~</span> median_income <span class="sc">+</span> unemployment_rate <span class="sc">+</span> share_college <span class="sc">+</span> car_density <span class="sc">+</span></span>
<span id="cb64-430"><a href="#cb64-430" aria-hidden="true" tabindex="-1"></a>                         w.median_income <span class="sc">+</span> w.unemployment_rate <span class="sc">+</span> w.share_college <span class="sc">+</span> w.car_density,</span>
<span id="cb64-431"><a href="#cb64-431" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">st_drop_geometry</span>(inkar_2020.spdf), </span>
<span id="cb64-432"><a href="#cb64-432" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ntree =</span> <span class="dv">1000</span>,</span>
<span id="cb64-433"><a href="#cb64-433" aria-hidden="true" tabindex="-1"></a>                       <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-434"><a href="#cb64-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-435"><a href="#cb64-435" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the mechanics of the model</span></span>
<span id="cb64-436"><a href="#cb64-436" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(rf.mod)</span>
<span id="cb64-437"><a href="#cb64-437" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf.mod)</span>
<span id="cb64-438"><a href="#cb64-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-439"><a href="#cb64-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-440"><a href="#cb64-440" aria-hidden="true" tabindex="-1"></a>You could even go further and use higher order neighbours (e.g. <span class="in">`nblag(queens.nb, maxlag = 3)`</span>) to check the importance of direct neighbours and the neighbours neighbours and so on ...</span>
<span id="cb64-441"><a href="#cb64-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-442"><a href="#cb64-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-443"><a href="#cb64-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-444"><a href="#cb64-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-445"><a href="#cb64-445" aria-hidden="true" tabindex="-1"></a><span class="fu">## Esimate an FE model with SLX specification</span></span>
<span id="cb64-446"><a href="#cb64-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-447"><a href="#cb64-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-448"><a href="#cb64-448" aria-hidden="true" tabindex="-1"></a>a) Loops over years to generate WX</span>
<span id="cb64-449"><a href="#cb64-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-452"><a href="#cb64-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-453"><a href="#cb64-453" aria-hidden="true" tabindex="-1"></a><span class="co"># We use gdp instead of median income (which is only available in recent year)</span></span>
<span id="cb64-454"><a href="#cb64-454" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> life_expectancy <span class="sc">~</span> gdp_in1000EUR <span class="sc">+</span> unemployment_rate <span class="sc">+</span> share_college <span class="sc">+</span> car_density</span>
<span id="cb64-455"><a href="#cb64-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-456"><a href="#cb64-456" aria-hidden="true" tabindex="-1"></a><span class="co"># All years where we have a balanced sample</span></span>
<span id="cb64-457"><a href="#cb64-457" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(inkar.df<span class="sc">$</span>year[<span class="fu">which</span>(<span class="fu">complete.cases</span>(inkar.df[, <span class="fu">all.vars</span>(fm)]))])</span>
<span id="cb64-458"><a href="#cb64-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-459"><a href="#cb64-459" aria-hidden="true" tabindex="-1"></a><span class="co"># All variables we want ot lag</span></span>
<span id="cb64-460"><a href="#cb64-460" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">all.vars</span>(fm)</span>
<span id="cb64-461"><a href="#cb64-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-462"><a href="#cb64-462" aria-hidden="true" tabindex="-1"></a><span class="co"># create listw with the correct rownames (ID = Kennziffer)</span></span>
<span id="cb64-463"><a href="#cb64-463" aria-hidden="true" tabindex="-1"></a>kreise.spdf<span class="sc">$</span>Kennziffer <span class="ot">&lt;-</span> kreise.spdf<span class="sc">$</span>ags</span>
<span id="cb64-464"><a href="#cb64-464" aria-hidden="true" tabindex="-1"></a>knn <span class="ot">&lt;-</span> <span class="fu">knearneigh</span>(<span class="fu">st_centroid</span>(kreise.spdf), <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb64-465"><a href="#cb64-465" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(knn, <span class="at">row.names =</span> kreise.spdf<span class="sc">$</span>Kennziffer)</span>
<span id="cb64-466"><a href="#cb64-466" aria-hidden="true" tabindex="-1"></a>listw <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(nb, <span class="at">style =</span> <span class="st">"W"</span>)</span>
<span id="cb64-467"><a href="#cb64-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-468"><a href="#cb64-468" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(y <span class="cf">in</span> years){</span>
<span id="cb64-469"><a href="#cb64-469" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select singe year</span></span>
<span id="cb64-470"><a href="#cb64-470" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> inkar.df[inkar.df<span class="sc">$</span>year <span class="sc">==</span> y ,]</span>
<span id="cb64-471"><a href="#cb64-471" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select variables and make df</span></span>
<span id="cb64-472"><a href="#cb64-472" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">st_drop_geometry</span>(tmp[, vars])</span>
<span id="cb64-473"><a href="#cb64-473" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add ID as rownames (we retreive them again later)</span></span>
<span id="cb64-474"><a href="#cb64-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(x) <span class="ot">&lt;-</span> tmp<span class="sc">$</span>Kennziffer</span>
<span id="cb64-475"><a href="#cb64-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform lag transformation (rownames contian ids)</span></span>
<span id="cb64-476"><a href="#cb64-476" aria-hidden="true" tabindex="-1"></a>  w.tmp <span class="ot">&lt;-</span> <span class="fu">create_WX</span>(<span class="fu">as.matrix</span>(x),</span>
<span id="cb64-477"><a href="#cb64-477" aria-hidden="true" tabindex="-1"></a>                    <span class="at">listw =</span> listw,</span>
<span id="cb64-478"><a href="#cb64-478" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prefix =</span> <span class="st">"w"</span>,</span>
<span id="cb64-479"><a href="#cb64-479" aria-hidden="true" tabindex="-1"></a>                    <span class="at">zero.policy =</span> <span class="cn">TRUE</span>) <span class="co"># NAs will get zero</span></span>
<span id="cb64-480"><a href="#cb64-480" aria-hidden="true" tabindex="-1"></a>  w.tmp <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(w.tmp)</span>
<span id="cb64-481"><a href="#cb64-481" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-482"><a href="#cb64-482" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add indices back</span></span>
<span id="cb64-483"><a href="#cb64-483" aria-hidden="true" tabindex="-1"></a>  w.tmp<span class="sc">$</span>Kennziffer <span class="ot">&lt;-</span> <span class="fu">row.names</span>(w.tmp)</span>
<span id="cb64-484"><a href="#cb64-484" aria-hidden="true" tabindex="-1"></a>  w.tmp<span class="sc">$</span>year <span class="ot">&lt;-</span> y</span>
<span id="cb64-485"><a href="#cb64-485" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-486"><a href="#cb64-486" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(y <span class="sc">==</span> years[<span class="dv">1</span>]){</span>
<span id="cb64-487"><a href="#cb64-487" aria-hidden="true" tabindex="-1"></a>    w.inkar.df <span class="ot">&lt;-</span> w.tmp</span>
<span id="cb64-488"><a href="#cb64-488" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb64-489"><a href="#cb64-489" aria-hidden="true" tabindex="-1"></a>    w.inkar.df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(w.inkar.df, w.tmp)</span>
<span id="cb64-490"><a href="#cb64-490" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-491"><a href="#cb64-491" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-492"><a href="#cb64-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-493"><a href="#cb64-493" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(w.inkar.df)</span>
<span id="cb64-494"><a href="#cb64-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-495"><a href="#cb64-495" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge back </span></span>
<span id="cb64-496"><a href="#cb64-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-497"><a href="#cb64-497" aria-hidden="true" tabindex="-1"></a>inkar.df <span class="ot">&lt;-</span> <span class="fu">merge</span>(inkar.df, w.inkar.df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Kennziffer"</span>, <span class="st">"year"</span>))</span>
<span id="cb64-498"><a href="#cb64-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-499"><a href="#cb64-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-500"><a href="#cb64-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-501"><a href="#cb64-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-502"><a href="#cb64-502" aria-hidden="true" tabindex="-1"></a>b) Estimate a twoways FE SLX panel model</span>
<span id="cb64-503"><a href="#cb64-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-506"><a href="#cb64-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-507"><a href="#cb64-507" aria-hidden="true" tabindex="-1"></a>slx.fe <span class="ot">&lt;-</span> <span class="fu">felm</span>(life_expectancy <span class="sc">~</span> gdp_in1000EUR <span class="sc">+</span> unemployment_rate <span class="sc">+</span> share_college <span class="sc">+</span> car_density <span class="sc">+</span></span>
<span id="cb64-508"><a href="#cb64-508" aria-hidden="true" tabindex="-1"></a>                 w.gdp_in1000EUR <span class="sc">+</span> w.unemployment_rate <span class="sc">+</span> w.share_college <span class="sc">+</span> w.car_density</span>
<span id="cb64-509"><a href="#cb64-509" aria-hidden="true" tabindex="-1"></a>                <span class="sc">|</span> Kennziffer <span class="sc">+</span> year <span class="sc">|</span> <span class="dv">0</span> <span class="sc">|</span> Kennziffer,</span>
<span id="cb64-510"><a href="#cb64-510" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> inkar.df)</span>
<span id="cb64-511"><a href="#cb64-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-512"><a href="#cb64-512" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(slx.fe)</span>
<span id="cb64-513"><a href="#cb64-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-514"><a href="#cb64-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-515"><a href="#cb64-515" aria-hidden="true" tabindex="-1"></a>c) Estimate a twoways FE SAR panel model (use <span class="in">`spml()`</span>)</span>
<span id="cb64-516"><a href="#cb64-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-519"><a href="#cb64-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-520"><a href="#cb64-520" aria-hidden="true" tabindex="-1"></a><span class="do">### Estimate model</span></span>
<span id="cb64-521"><a href="#cb64-521" aria-hidden="true" tabindex="-1"></a>sar.fe <span class="ot">&lt;-</span> <span class="fu">spml</span>(life_expectancy <span class="sc">~</span> gdp_in1000EUR <span class="sc">+</span> unemployment_rate <span class="sc">+</span> share_college <span class="sc">+</span> car_density, </span>
<span id="cb64-522"><a href="#cb64-522" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> inkar.df, </span>
<span id="cb64-523"><a href="#cb64-523" aria-hidden="true" tabindex="-1"></a>               <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"Kennziffer"</span>, <span class="st">"year"</span>), </span>
<span id="cb64-524"><a href="#cb64-524" aria-hidden="true" tabindex="-1"></a>               <span class="at">listw =</span> listw, </span>
<span id="cb64-525"><a href="#cb64-525" aria-hidden="true" tabindex="-1"></a>               <span class="at">model=</span> <span class="st">"within"</span>,</span>
<span id="cb64-526"><a href="#cb64-526" aria-hidden="true" tabindex="-1"></a>               <span class="at">effect=</span> <span class="st">"twoways"</span>,</span>
<span id="cb64-527"><a href="#cb64-527" aria-hidden="true" tabindex="-1"></a>               <span class="at">lag =</span> <span class="cn">TRUE</span>, </span>
<span id="cb64-528"><a href="#cb64-528" aria-hidden="true" tabindex="-1"></a>               <span class="at">spatial.error =</span> <span class="st">"none"</span></span>
<span id="cb64-529"><a href="#cb64-529" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb64-530"><a href="#cb64-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-531"><a href="#cb64-531" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sar.fe)</span>
<span id="cb64-532"><a href="#cb64-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-533"><a href="#cb64-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-534"><a href="#cb64-534" aria-hidden="true" tabindex="-1"></a>d) Estimate the summary impacts.</span>
<span id="cb64-535"><a href="#cb64-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-538"><a href="#cb64-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-539"><a href="#cb64-539" aria-hidden="true" tabindex="-1"></a>sar.fe.imp <span class="ot">&lt;-</span> <span class="fu">impacts</span>(sar.fe, <span class="at">listw =</span> listw, <span class="at">time =</span> <span class="fu">length</span>(years), <span class="at">R =</span> <span class="dv">200</span>)</span>
<span id="cb64-540"><a href="#cb64-540" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sar.fe.imp, <span class="at">zstats =</span> <span class="cn">TRUE</span>, <span class="at">short =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-541"><a href="#cb64-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-542"><a href="#cb64-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-543"><a href="#cb64-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-544"><a href="#cb64-544" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We use the `WDI` API package to retrieve data from the World Bank. --&gt;</span></span>
<span id="cb64-545"><a href="#cb64-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-546"><a href="#cb64-546" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- You can open the [World Bank Data browser](https://databank.worldbank.org/home.aspx) to go though the data. --&gt;</span></span>
<span id="cb64-547"><a href="#cb64-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-548"><a href="#cb64-548" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- You can search for indicators with `WDIsearch()`. --&gt;</span></span>
<span id="cb64-549"><a href="#cb64-549" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r warning=FALSE} --&gt;</span></span>
<span id="cb64-550"><a href="#cb64-550" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library(WDI) --&gt;</span></span>
<span id="cb64-551"><a href="#cb64-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-552"><a href="#cb64-552" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Search GDP per capita --&gt;</span></span>
<span id="cb64-553"><a href="#cb64-553" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- WDIsearch("CO2 intensity") --&gt;</span></span>
<span id="cb64-554"><a href="#cb64-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-555"><a href="#cb64-555" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Political Stability --&gt;</span></span>
<span id="cb64-556"><a href="#cb64-556" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- WDIsearch("Political Stability") --&gt;</span></span>
<span id="cb64-557"><a href="#cb64-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-558"><a href="#cb64-558" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb64-559"><a href="#cb64-559" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- WDIsearch("democracy") --&gt;</span></span>
<span id="cb64-560"><a href="#cb64-560" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # The Democracy indicator is an additive eleven-point scale (0-10) --&gt;</span></span>
<span id="cb64-561"><a href="#cb64-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-562"><a href="#cb64-562" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb64-563"><a href="#cb64-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-564"><a href="#cb64-564" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r, cache=TRUE} --&gt;</span></span>
<span id="cb64-565"><a href="#cb64-565" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Define countries, indicators to query, and time period --&gt;</span></span>
<span id="cb64-566"><a href="#cb64-566" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- wd.df &lt;- WDI(country = "all",  --&gt;</span></span>
<span id="cb64-567"><a href="#cb64-567" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              indicator = c('population' = "SP.POP.TOTL",  --&gt;</span></span>
<span id="cb64-568"><a href="#cb64-568" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            'gdp_pc' = "NY.GDP.PCAP.KD",  --&gt;</span></span>
<span id="cb64-569"><a href="#cb64-569" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            'co2_pc' = "EN.ATM.CO2E.PC", --&gt;</span></span>
<span id="cb64-570"><a href="#cb64-570" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            'co2_intesity' = "EN.ATM.CO2E.EG.ZS", --&gt;</span></span>
<span id="cb64-571"><a href="#cb64-571" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            'gini' = "SI.POV.GINI", --&gt;</span></span>
<span id="cb64-572"><a href="#cb64-572" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            'political_stability' = "GV.POLI.ST.ES", --&gt;</span></span>
<span id="cb64-573"><a href="#cb64-573" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            'inst_democr' = "UPP.INS.DEMO.XQ"), --&gt;</span></span>
<span id="cb64-574"><a href="#cb64-574" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              extra = TRUE, --&gt;</span></span>
<span id="cb64-575"><a href="#cb64-575" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              start = 2010, end = 2019) --&gt;</span></span>
<span id="cb64-576"><a href="#cb64-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-577"><a href="#cb64-577" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Save --&gt;</span></span>
<span id="cb64-578"><a href="#cb64-578" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- save(wd.df, file = "_data/WDI_data.RData") --&gt;</span></span>
<span id="cb64-579"><a href="#cb64-579" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb64-580"><a href="#cb64-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-581"><a href="#cb64-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-582"><a href="#cb64-582" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Diffusion of political regimes --&gt;</span></span>
<span id="cb64-583"><a href="#cb64-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-584"><a href="#cb64-584" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- See for instance @Gleditsch.2006 for an example for the diffusion of democratization. --&gt;</span></span>
<span id="cb64-585"><a href="#cb64-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-586"><a href="#cb64-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-587"><a href="#cb64-587" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>